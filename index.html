<!DOCTYPE html>
<html lang="ru">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
<title>Suno Global Canvas (Stable Pro)</title>
<style>
/* --- 1. –°–¢–ò–õ–¨ --- */
:root {
  --main-bg: #121212;
  --top-bar-bg: #222222;
  --control-bg: #333333;
  --accent-color: #008cff;
  --text-color: #f0f0f0;
  --border-color: #555;
  --danger-color: #ff3b30;
}

body {
  margin: 0;
  background: var(--main-bg);
  color: var(--text-color);
  font-family: sans-serif;
  overflow: hidden; /* –ë–ª–æ–∫–∏—Ä—É–µ–º —Å–∫—Ä–æ–ª–ª —Å—Ç—Ä–∞–Ω–∏—Ü—ã */
  touch-action: pan-x pan-y; /* –†–∞–∑—Ä–µ—à–∞–µ–º —Å—Ç–∞–Ω–¥–∞—Ä—Ç–Ω—ã–µ –∂–µ—Å—Ç—ã –≤–Ω–µ —Ö–æ–ª—Å—Ç–∞ */
}

/* –í–µ—Ä—Ö–Ω—è—è –ø–∞–Ω–µ–ª—å */
#top {
  background: var(--top-bar-bg);
  padding: 8px;
  display: flex;
  gap: 8px;
  align-items: center;
  border-bottom: 1px solid var(--border-color);
  overflow-x: auto;
  position: absolute;
  top: 0; left: 0; right: 0;
  height: 60px;
  z-index: 100;
  box-sizing: border-box;
  touch-action: manipulation; /* –ö–Ω–æ–ø–∫–∏ –¥–æ–ª–∂–Ω—ã –Ω–∞–∂–∏–º–∞—Ç—å—Å—è! */
}
#top::-webkit-scrollbar { display: none; }

button, input:not([type=range]) {
  background: var(--control-bg);
  color: var(--text-color);
  border: 1px solid var(--border-color);
  border-radius: 4px;
  padding: 8px 12px;
  font-size: 14px;
  cursor: pointer;
  flex-shrink: 0;
}
button:active { transform: scale(0.95); } /* –ê–Ω–∏–º–∞—Ü–∏—è –Ω–∞–∂–∞—Ç–∏—è */
button.active { border-color: var(--accent-color); color: var(--accent-color); }
.danger-btn { border-color: var(--danger-color) !important; color: var(--danger-color) !important; }

/* –ü–æ–ª–∑—É–Ω–∫–∏ */
input[type=range] {
  -webkit-appearance: none;
  background: var(--border-color);
  height: 6px;
  border-radius: 4px;
  width: 100%;
  margin: 10px 0;
}
input[type=range]::-webkit-slider-thumb {
  -webkit-appearance: none;
  width: 20px; height: 20px;
  border-radius: 50%;
  background: var(--accent-color);
  border: 2px solid #fff;
}

.control-group {
  display: flex; align-items: center; gap: 5px; flex-shrink: 0;
}
.control-group input[type=number] { width: 50px; text-align: center; }

/* --- 2. –û–ë–õ–ê–°–¢–¨ –†–ò–°–û–í–ê–ù–ò–Ø (VIEWPORT) --- */
#viewport {
    position: absolute;
    top: 60px; bottom: 0; left: 0; right: 0;
    background: #1a1a1a;
    overflow: hidden;
    touch-action: none; /* –í–ê–ñ–ù–û: –¢—É—Ç —Å–≤–æ–∏ –∂–µ—Å—Ç—ã (–∑—É–º/—Ä–∏—Å) */
    display: flex;
    justify-content: center;
    align-items: center;
}

canvas {
  display: block;
  background: #fff;
  box-shadow: 0 0 30px rgba(0,0,0,0.5);
  transform-origin: 0 0; /* –ó—É–º –æ—Ç –ª–µ–≤–æ–≥–æ –≤–µ—Ä—Ö–Ω–µ–≥–æ —É–≥–ª–∞ (–ª–æ–≥–∏–∫–∞ JS) */
}

/* --- 3. –ò–ù–°–¢–†–£–ú–ï–ù–¢–´ --- */
#tools {
  position: absolute; left: 10px; top: 70px;
  background: var(--control-bg);
  padding: 10px;
  border-radius: 8px;
  display: none;
  flex-direction: column;
  gap: 15px;
  z-index: 50;
  border: 1px solid #555;
}
.tool-btn { font-size: 24px; background: transparent; border: none; padding: 5px; }
.tool-btn.active { transform: scale(1.2); text-shadow: 0 0 10px var(--accent-color); }

#color-panel {
    display: none;
    position: absolute; right: 10px; top: 70px;
    width: 250px;
    background: rgba(30, 30, 30, 0.95);
    padding: 15px;
    border-radius: 8px;
    flex-direction: column;
    z-index: 50;
    border: 1px solid #555;
}

#gallery { 
  position: fixed; top: 0; left: 0; right: 0; bottom: 0;
  background: rgba(0,0,0,0.95); 
  padding: 20px; 
  display: none; 
  flex-direction: column;
  overflow-y: auto; 
  z-index: 2000;
}
.gallery-grid {
    display: grid; grid-template-columns: repeat(auto-fill, minmax(140px, 1fr)); gap: 10px;
}
.gallery-item { background: #222; padding: 10px; border-radius: 8px; text-align: center; }
.gallery-item img { width: 100%; height: 120px; object-fit: contain; background: #000; }
</style>
</head>
<body>

<div id="top">
  <button onclick="toggleTools()">üõ† –ò–Ω—Å—Ç—Ä.</button>
  <button onclick="toggleColors()">üé® –¶–≤–µ—Ç</button>
  <button onclick="toggleGallery()">üåç –ì–∞–ª–µ—Ä–µ—è</button>
  <div style="width:1px; height:20px; background:#555; margin:0 5px;"></div>
  <button onclick="window.saveToCloud()" style="color:var(--danger-color)">‚òÅÔ∏è Public</button>
  <button onclick="downloadImg()">üíæ Save</button>
  <button onclick="clearCanvas()" class="danger-btn">üóë</button>
  
  <div class="control-group">
     <label>W:</label><input type="number" id="canvasW" value="720" onchange="resizeC()">
  </div>
  <div class="control-group">
     <label>H:</label><input type="number" id="canvasH" value="1080" onchange="resizeC()">
  </div>
</div>

<div id="tools">
    <button class="tool-btn active" onclick="setMode('draw', this)">‚úèÔ∏è</button>
    <button class="tool-btn" onclick="setMode('erase', this)">üßΩ</button>
    <button class="tool-btn" onclick="setMode('fill', this)">‚¨õ</button>
    <button class="tool-btn" onclick="resetView()">üéØ</button>
</div>

<div id="color-panel">
    <div style="display:flex; justify-content:space-between;">
        <h3>–ù–∞—Å—Ç—Ä–æ–π–∫–∏</h3><button onclick="toggleColors()">‚úï</button>
    </div>
    <div id="preview" style="height:30px; background:#000; margin:10px 0; border:1px solid #fff;"></div>
    
    <label>R</label><input type="range" id="r" max="255" value="0" oninput="updColor()">
    <label>G</label><input type="range" id="g" max="255" value="0" oninput="updColor()">
    <label>B</label><input type="range" id="b" max="255" value="0" oninput="updColor()">
    <hr style="border-color:#444">
    <label>–†–∞–∑–º–µ—Ä –∫–∏—Å—Ç–∏: <span id="s_val">5</span></label>
    <input type="range" id="size" min="1" max="100" value="5" oninput="document.getElementById('s_val').innerText=this.value">
</div>

<div id="viewport">
    <canvas id="canvas" width="720" height="1080"></canvas>
</div>

<div id="gallery">
    <div style="display:flex; justify-content:space-between; margin-bottom:10px;">
        <h2 style="margin:0">–ì–∞–ª–µ—Ä–µ—è</h2><button onclick="toggleGallery()">–ó–∞–∫—Ä—ã—Ç—å</button>
    </div>
    <div id="galleryContent" class="gallery-grid">–ó–∞–≥—Ä—É–∑–∫–∞...</div>
</div>

<script>
// –ì–ª–æ–±–∞–ª—å–Ω—ã–µ –ø–µ—Ä–µ–º–µ–Ω–Ω—ã–µ
const canvas = document.getElementById("canvas");
const ctx = canvas.getContext("2d");
const viewport = document.getElementById("viewport");
const rEl = document.getElementById("r"); 
const gEl = document.getElementById("g"); 
const bEl = document.getElementById("b");
const sizeEl = document.getElementById("size");
const preview = document.getElementById("preview");

let mode = "draw";
let isDrawing = false;
let startX = 0, startY = 0; // –î–ª—è –∂–µ—Å—Ç–æ–≤
let pointX = 0, pointY = 0; // –ü–æ–∑–∏—Ü–∏—è —Ö–æ–ª—Å—Ç–∞
let scale = 1; // –ó—É–º
let startScale = 1;
let startDist = 0;
let lastX = 0, lastY = 0; // –î–ª—è —Ä–∏—Å–æ–≤–∞–Ω–∏—è

// --- UI –§–£–ù–ö–¶–ò–ò ---
function toggleTools() { 
    const t = document.getElementById("tools");
    t.style.display = (t.style.display === "flex") ? "none" : "flex"; 
}
function toggleColors() { 
    const c = document.getElementById("color-panel");
    c.style.display = (c.style.display === "flex") ? "none" : "flex"; 
}
function toggleGallery() {
    const g = document.getElementById("gallery");
    const isHidden = (getComputedStyle(g).display === "none");
    g.style.display = isHidden ? "flex" : "none";
    if(isHidden && window.loadCloudGallery) window.loadCloudGallery();
}
function setMode(m, btn) {
    mode = m;
    document.querySelectorAll('.tool-btn').forEach(b => b.classList.remove('active'));
    if(btn) btn.classList.add('active');
}
function updColor() {
    preview.style.backgroundColor = `rgb(${rEl.value},${gEl.value},${bEl.value})`;
}
function getColor() { return `rgb(${rEl.value},${gEl.value},${bEl.value})`; }

function resizeC() {
    const w = document.getElementById('canvasW').value;
    const h = document.getElementById('canvasH').value;
    const temp = document.createElement('canvas');
    temp.width = canvas.width; temp.height = canvas.height;
    temp.getContext('2d').drawImage(canvas,0,0);
    canvas.width = w; canvas.height = h;
    ctx.drawImage(temp,0,0);
    centerCanvas();
}
function downloadImg() {
    const a = document.createElement('a');
    a.download = 'art.png';
    a.href = canvas.toDataURL();
    a.click();
}
function clearCanvas() {
    ctx.fillStyle = "#ffffff";
    ctx.fillRect(0,0,canvas.width,canvas.height);
}

// --- –°–ò–°–¢–ï–ú–ê –ñ–ï–°–¢–û–í (2 –ü–ê–õ–¨–¶–ê) ---
function updateTransform() {
    canvas.style.transform = `translate(${pointX}px, ${pointY}px) scale(${scale})`;
}
function centerCanvas() {
    // –¶–µ–Ω—Ç—Ä–∏—Ä—É–µ–º —Ö–æ–ª—Å—Ç –≤ –≤—å—é–ø–æ—Ä—Ç–µ
    const vw = viewport.clientWidth;
    const vh = viewport.clientHeight;
    // –ù–∞—á–∞–ª—å–Ω–∞—è –ø–æ–∑–∏—Ü–∏—è: —Ü–µ–Ω—Ç—Ä —ç–∫—Ä–∞–Ω–∞ –º–∏–Ω—É—Å –ø–æ–ª–æ–≤–∏–Ω–∞ —Ö–æ–ª—Å—Ç–∞
    pointX = (vw - canvas.width * scale) / 2 + (canvas.width * scale - canvas.width)/2; // –°–ª–æ–∂–Ω–∞—è —Ñ–æ—Ä–º—É–ª–∞ —É–ø—Ä–æ—â–∞–µ—Ç—Å—è –¥–æ —Ç—Ä–∞–Ω—Å–ª–µ–π—Ç
    // –ü—Ä–æ—Å—Ç–æ–π —Å–ø–æ—Å–æ–±: CSS transform origin 0 0.
    // –ó–Ω–∞—á–∏—Ç pointX –¥–æ–ª–∂–µ–Ω –±—ã—Ç—å —Ç–∞–∫–∏–º, —á—Ç–æ–±—ã (0,0) —Ö–æ–ª—Å—Ç–∞ —Å–¥–≤–∏–Ω—É–ª—Å—è
    pointX = (vw - canvas.width)/2; 
    pointY = (vh - canvas.height)/2;
    scale = Math.min(vw/canvas.width, vh/canvas.height) * 0.9; // –ê–≤—Ç–æ–∑—É–º —á—Ç–æ–±—ã –≤–ª–µ–∑–ª–æ
    if(scale < 0.1) scale = 0.5;
    updateTransform();
}

function getDist(touches) {
    return Math.hypot(touches[0].clientX - touches[1].clientX, touches[0].clientY - touches[1].clientY);
}
function getMid(touches) {
    return { x: (touches[0].clientX + touches[1].clientX)/2, y: (touches[0].clientY + touches[1].clientY)/2 };
}
// –ü–µ—Ä–µ–≤–æ–¥ –∫–æ–æ—Ä–¥–∏–Ω–∞—Ç —ç–∫—Ä–∞–Ω–∞ –≤ –∫–æ–æ—Ä–¥–∏–Ω–∞—Ç—ã —Ö–æ–ª—Å—Ç–∞
function getCanvasPos(e) {
    const rect = viewport.getBoundingClientRect();
    const cx = e.touches ? e.touches[0].clientX : e.clientX;
    const cy = e.touches ? e.touches[0].clientY : e.clientY;
    // –§–æ—Ä–º—É–ª–∞ –æ–±—Ä–∞—Ç–Ω–æ–π –ø—Ä–æ–µ–∫—Ü–∏–∏
    return {
        x: (cx - rect.left - pointX) / scale,
        y: (cy - rect.top - pointY) / scale
    };
}

// –û–±—Ä–∞–±–æ—Ç—á–∏–∫–∏ –∫–∞—Å–∞–Ω–∏–π
viewport.addEventListener('touchstart', onTouchStart, {passive: false});
viewport.addEventListener('touchmove', onTouchMove, {passive: false});
viewport.addEventListener('touchend', onTouchEnd);
// –ú—ã—à—å (–¥–ª—è —Ç–µ—Å—Ç–æ–≤ –Ω–∞ –ü–ö)
viewport.addEventListener('mousedown', (e)=>{ e.touches=[e]; onTouchStart(e); });
viewport.addEventListener('mousemove', (e)=>{ if(isDrawing) {e.touches=[e]; onTouchMove(e);} });
viewport.addEventListener('mouseup', onTouchEnd);

function onTouchStart(e) {
    if(e.touches.length === 2) {
        // –ù–∞—á–∞–ª–æ –∂–µ—Å—Ç–∞ (–∑—É–º/–ø–∞–Ω)
        isDrawing = false;
        startDist = getDist(e.touches);
        startScale = scale;
        const mid = getMid(e.touches);
        startX = mid.x - pointX;
        startY = mid.y - pointY;
        return;
    }
    if(e.touches.length === 1) {
        // –†–∏—Å–æ–≤–∞–Ω–∏–µ
        if(mode === 'fill') {
            ctx.fillStyle = getColor(); 
            ctx.fillRect(0,0,canvas.width,canvas.height);
            return;
        }
        isDrawing = true;
        const p = getCanvasPos(e);
        lastX = p.x; lastY = p.y;
        // –¢–æ—á–∫–∞ (–µ—Å–ª–∏ –ø—Ä–æ—Å—Ç–æ —Ç–∫–Ω—É–ª–∏)
        ctx.fillStyle = getColor();
        ctx.beginPath();
        ctx.arc(p.x, p.y, sizeEl.value/2, 0, Math.PI*2);
        ctx.fill();
    }
}

function onTouchMove(e) {
    e.preventDefault(); // –ë–ª–æ–∫–∏—Ä—É–µ–º —Å–∫—Ä–æ–ª–ª –±—Ä–∞—É–∑–µ—Ä–∞

    // –ñ–µ—Å—Ç 2 –ø–∞–ª—å—Ü–∞–º–∏
    if(e.touches.length === 2) {
        isDrawing = false;
        // –ó—É–º
        const newDist = getDist(e.touches);
        scale = startScale * (newDist / startDist);
        if(scale < 0.1) scale = 0.1;
        if(scale > 10) scale = 10;
        
        // –ü–∞–Ω (–°–¥–≤–∏–≥)
        const mid = getMid(e.touches);
        pointX = mid.x - startX;
        pointY = mid.y - startY;
        
        updateTransform();
        return;
    }

    // –†–∏—Å–æ–≤–∞–Ω–∏–µ 1 –ø–∞–ª—å—Ü–µ–º
    if(isDrawing && e.touches.length === 1) {
        const p = getCanvasPos(e);
        
        ctx.beginPath();
        ctx.moveTo(lastX, lastY);
        ctx.lineTo(p.x, p.y);
        
        ctx.strokeStyle = getColor();
        ctx.lineWidth = sizeEl.value;
        ctx.lineCap = "round";
        ctx.lineJoin = "round";
        
        if(mode === 'erase') {
            ctx.globalCompositeOperation = 'destination-out';
        } else {
            ctx.globalCompositeOperation = 'source-over';
        }
        
        ctx.stroke();
        lastX = p.x; lastY = p.y;
    }
}

function onTouchEnd() {
    isDrawing = false;
    ctx.beginPath(); // –°–±—Ä–æ—Å –ø—É—Ç–∏
}

function resetView() {
    scale = 1;
    centerCanvas();
}

// –ü—Ä–µ–¥–æ—Ç–≤—Ä–∞—â–∞–µ–º –±–∞–≥–∏ —Å–ª–∞–π–¥–µ—Ä–æ–≤
document.querySelectorAll('input[type=range]').forEach(i => {
    i.addEventListener('touchstart', e => e.stopPropagation());
    i.addEventListener('touchmove', e => e.stopPropagation());
});

// –°—Ç–∞—Ä—Ç
clearCanvas();
updColor();
setTimeout(centerCanvas, 100);

</script>

<script type="module">
  import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
  import { getFirestore, collection, addDoc, getDocs, query, orderBy, limit, doc, updateDoc, increment, deleteDoc, arrayUnion } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

  const firebaseConfig = {
    apiKey: "AIzaSyCekB6vZ6qGAnvDO1LOA7OUGmA3zU1aLoA",
    authDomain: "suno-gallery.firebaseapp.com",
    projectId: "suno-gallery",
    storageBucket: "suno-gallery.firebasestorage.app",
    messagingSenderId: "314284584278",
    appId: "1:314284584278:web:97c5b91180562fd1c93af7",
    measurementId: "G-2J4PNZX4CV"
  };

  let db, galleryRef;
  let USER_ID = localStorage.getItem("u_id") || 'u_'+Date.now();
  localStorage.setItem("u_id", USER_ID);

  try {
      const app = initializeApp(firebaseConfig);
      db = getFirestore(app);
      galleryRef = collection(db, "drawings");
      console.log("Firebase OK");
  } catch(e) {
      console.error("Firebase Error:", e);
  }

  // –ü—Ä–∏–≤—è–∑—ã–≤–∞–µ–º —Ñ—É–Ω–∫—Ü–∏–∏ –∫ window, —á—Ç–æ–±—ã –∫–Ω–æ–ø–∫–∏ –∏—Ö –≤–∏–¥–µ–ª–∏
  window.saveToCloud = async () => {
      if(!db) { alert("–ù–µ—Ç —Å–æ–µ–¥–∏–Ω–µ–Ω–∏—è —Å –±–∞–∑–æ–π!"); return; }
      if(!confirm("–û–ø—É–±–ª–∏–∫–æ–≤–∞—Ç—å?")) return;
      try {
          await addDoc(galleryRef, {
              image: canvas.toDataURL(),
              date: Date.now(),
              deleteVotes: 0,
              voters: []
          });
          alert("–ì–æ—Ç–æ–≤–æ!");
          window.toggleGallery();
      } catch(e) { alert("–û—à–∏–±–∫–∞: "+e.message); }
  };

  window.loadCloudGallery = async () => {
      const el = document.getElementById("galleryContent");
      if(!db) { el.innerHTML = "–ù–µ—Ç —Å–æ–µ–¥–∏–Ω–µ–Ω–∏—è."; return; }
      
      el.innerHTML = "–ó–∞–≥—Ä—É–∑–∫–∞...";
      try {
          const q = query(galleryRef, orderBy("date", "desc"), limit(20));
          const snap = await getDocs(q);
          el.innerHTML = "";
          snap.forEach(docSnap => {
             const data = docSnap.data();
             const div = document.createElement("div");
             div.className = "gallery-item";
             div.innerHTML = `
                <img src="${data.image}">
                <div style="margin-top:5px; color:#555; font-size:10px;">Votes: ${data.deleteVotes || 0}/10</div>
                <button class="danger-btn" style="padding:2px 5px; font-size:10px; margin-top:5px;">Report</button>
             `;
             // –ö–ª–∏–∫ –ø–æ –∫–∞—Ä—Ç–∏–Ω–∫–µ - –∑–∞–≥—Ä—É–∑–∫–∞
             div.querySelector('img').onclick = () => {
                 if(confirm("–ó–∞–≥—Ä—É–∑–∏—Ç—å —Ä–∏—Å—É–Ω–æ–∫?")) {
                    const i = new Image(); i.src = data.image;
                    i.onload = () => {
                        window.clearCanvas();
                        ctx.drawImage(i,0,0);
                    }
                    window.toggleGallery();
                 }
             };
             // –ö–ª–∏–∫ –ø–æ Report
             div.querySelector('button').onclick = async () => {
                 if(data.voters && data.voters.includes(USER_ID)) { alert("–£–∂–µ –≥–æ–ª–æ—Å–æ–≤–∞–ª–∏"); return; }
                 if(!confirm("–ü–æ–∂–∞–ª–æ–≤–∞—Ç—å—Å—è?")) return;
                 const newV = (data.deleteVotes||0) + 1;
                 const ref = doc(db, "drawings", docSnap.id);
                 if(newV >= 10) { await deleteDoc(ref); div.remove(); }
                 else {
                     await updateDoc(ref, { deleteVotes: increment(1), voters: arrayUnion(USER_ID) });
                     alert("–ì–æ–ª–æ—Å —É—á—Ç–µ–Ω");
                 }
             };
             el.appendChild(div);
          });
      } catch(e) { el.innerHTML = "–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏."; }
  };
</script>

</body>
  </html>
  
