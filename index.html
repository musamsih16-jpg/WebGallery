<!DOCTYPE html>
<html lang="ru">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
<title>Suno Global Canvas (Final)</title>
<style>
:root {
  --main-bg: #121212;
  --top-bar-bg: #222222;
  --control-bg: #333333;
  --accent-color: #008cff;
  --text-color: #f0f0f0;
}

body {
  margin: 0; padding: 0;
  background: var(--main-bg);
  color: var(--text-color);
  font-family: sans-serif;
  display: flex; flex-direction: column;
  height: 100vh; overflow: hidden;
}

/* –ú–ï–ù–Æ */
#top {
  background: var(--top-bar-bg);
  padding: 10px;
  display: flex; gap: 8px;
  align-items: center;
  border-bottom: 2px solid #444;
  overflow-x: auto;
  flex-shrink: 0;
  z-index: 9999;
}

button {
  background: var(--control-bg);
  color: #fff;
  border: 1px solid #555;
  border-radius: 6px;
  padding: 10px 14px;
  font-size: 14px;
  white-space: nowrap;
  cursor: pointer;
}

button:active { background: var(--accent-color); }

/* –•–û–õ–°–¢ */
#viewport {
  flex-grow: 1;
  position: relative;
  background: #1a1a1a;
  overflow: hidden;
  touch-action: none;
}

canvas {
  position: absolute;
  background: #fff;
  transform-origin: 0 0;
}

/* –ü–ê–ù–ï–õ–ò */
#tools, #color-panel {
  position: fixed;
  top: 75px;
  background: rgba(35, 35, 35, 0.95);
  border: 1px solid #555;
  border-radius: 8px;
  padding: 12px;
  display: none;
  z-index: 10000;
  flex-direction: column;
  gap: 12px;
}
#tools { left: 10px; }
#color-panel { right: 10px; width: 200px; }

input[type=range] { width: 100%; height: 20px; }

/* –ì–ê–õ–ï–†–ï–Ø */
#gallery {
  position: fixed; inset: 0;
  background: #000;
  z-index: 20000;
  display: none;
  flex-direction: column;
  padding: 15px;
  overflow-y: auto;
}
.grid {
  display: grid;
  grid-template-columns: repeat(auto-fill, minmax(140px, 1fr));
  gap: 10px;
  margin-top: 15px;
}
.card { background: #222; padding: 8px; border-radius: 8px; text-align: center; }
.card img { width: 100%; height: 100px; object-fit: contain; background: #000; }
</style>
</head>
<body>

<div id="top">
  <button onclick="toggleEl('tools')">üõ†</button>
  <button onclick="toggleEl('color-panel')">üé®</button>
  <button onclick="toggleEl('gallery')">üåç –ì–ª–æ–±–∞–ª—å–Ω–æ</button>
  <button onclick="resetView()">üéØ –¶–µ–Ω—Ç—Ä</button>
  <button onclick="saveToCloud()" style="border-color: #008cff;">‚òÅÔ∏è –ó–∞–ø—É—Å—Ç–∏—Ç—å –≥–ª–æ–±–∞–ª—å–Ω–æ</button>
  <button onclick="downloadImg()">üíæ –°–æ—Ö—Ä–∞–Ω–∏—Ç—å —É—Å—Ç—Ä–æ–π—Å—Ç–≤–æ</button>
  <button onclick="clearCanvas()" style="color:red">üóë</button>
</div>

<div id="tools">
    <button onclick="setMode('draw')">‚úèÔ∏è –ö–∏—Å—Ç—å</button>
    <button onclick="setMode('erase')">üßΩ –õ–∞—Å—Ç–∏–∫</button>
    <button onclick="setMode('fill')">‚¨õ –ó–∞–ª–∏–≤–∫–∞</button>
</div>

<div id="color-panel">
    <label>–†–∞–∑–º–µ—Ä: <span id="sz_val">5</span></label>
    <input type="range" id="size" min="1" max="100" value="5" oninput="document.getElementById('sz_val').innerText=this.value">
    <label>–¶–≤–µ—Ç:</label>
    <input type="range" id="r" max="255" value="0">
    <input type="range" id="g" max="255" value="0">
    <input type="range" id="b" max="255" value="0">
</div>

<div id="viewport">
    <canvas id="canvas" width="720" height="1280"></canvas>
</div>

<div id="gallery">
    <button onclick="toggleEl('gallery')">‚ùå –ó–∞–∫—Ä—ã—Ç—å –≥–∞–ª–µ—Ä–µ—é</button>
    <div id="galleryContent" class="grid">–ó–∞–≥—Ä—É–∑–∫–∞...</div>
</div>

<script type="module">
// --- FIREBASE –ò –õ–û–ì–ò–ö–ê –ñ–ê–õ–û–ë ---
import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
import { getFirestore, collection, addDoc, getDocs, query, orderBy, limit, doc, updateDoc, increment, deleteDoc, arrayUnion } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

const firebaseConfig = {
    apiKey: "AIzaSyCekB6vZ6qGAnvDO1LOA7OUGmA3zU1aLoA",
    authDomain: "suno-gallery.firebaseapp.com",
    projectId: "suno-gallery",
    storageBucket: "suno-gallery.firebasestorage.app",
    messagingSenderId: "314284584278",
    appId: "1:314284584278:web:97c5b91180562fd1c93af7"
};

const app = initializeApp(firebaseConfig);
const db = getFirestore(app);
const galleryRef = collection(db, "drawings");

// –£–Ω–∏–∫–∞–ª—å–Ω—ã–π ID –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –¥–ª—è –±–ª–æ–∫–∏—Ä–æ–≤–∫–∏ –ø–æ–≤—Ç–æ—Ä–Ω—ã—Ö –∂–∞–ª–æ–±
let USER_ID = localStorage.getItem("art_uid") || 'u' + Math.random().toString(36).substr(2, 9);
localStorage.setItem("art_uid", USER_ID);

window.saveToCloud = async () => {
    if(!confirm("–û–ø—É–±–ª–∏–∫–æ–≤–∞—Ç—å —Ä–∏—Å—É–Ω–æ–∫ –≤ –≥–ª–æ–±–∞–ª—å–Ω—É—é –≥–∞–ª–µ—Ä–µ—é?")) return;
    try {
        await addDoc(galleryRef, {
            image: canvas.toDataURL('image/jpeg', 0.5),
            date: Date.now(),
            reports: 0,
            reporters: [] // –°–ø–∏—Å–æ–∫ ID —Ç–µ—Ö, –∫—Ç–æ –ø–æ–∂–∞–ª–æ–≤–∞–ª—Å—è
        });
        alert("–û–ø—É–±–ª–∏–∫–æ–≤–∞–Ω–æ!");
    } catch(e) { alert("–û—à–∏–±–∫–∞: " + e.message); }
};

window.loadGallery = async () => {
    const cont = document.getElementById("galleryContent");
    cont.innerHTML = "–ó–∞–≥—Ä—É–∑–∫–∞...";
    const q = query(galleryRef, orderBy("date", "desc"), limit(24));
    const snap = await getDocs(q);
    cont.innerHTML = "";
    snap.forEach(d => {
        const item = d.data();
        const card = document.createElement("div");
        card.className = "card";
        card.innerHTML = `
            <img src="${item.image}">
            <button id="rep-${d.id}" style="font-size:10px; margin-top:5px; background:#444">Report (${item.reports||0})</button>
        `;
        
        const btn = card.querySelector("button");
        btn.onclick = async () => {
            if(item.reporters && item.reporters.includes(USER_ID)) {
                alert("–í—ã —É–∂–µ –∂–∞–ª–æ–≤–∞–ª–∏—Å—å –Ω–∞ —ç—Ç–æ—Ç —Ä–∏—Å—É–Ω–æ–∫.");
                return;
            }
            if(!confirm("–ü–æ–∂–∞–ª–æ–≤–∞—Ç—å—Å—è –Ω–∞ —Å–æ–¥–µ—Ä–∂–∞–Ω–∏–µ?")) return;
            
            const docRef = doc(db, "drawings", d.id);
            const newReports = (item.reports || 0) + 1;
            
            if(newReports >= 5) {
                await deleteDoc(docRef);
                card.remove();
            } else {
                await updateDoc(docRef, {
                    reports: increment(1),
                    reporters: arrayUnion(USER_ID)
                });
                btn.innerText = `Reported`;
                btn.disabled = true;
            }
        };
        cont.appendChild(card);
    });
};
</script>

<script>
// --- –û–°–ù–û–í–ù–û–ô –î–í–ò–ñ–ï–ö ---
const canvas = document.getElementById('canvas');
const ctx = canvas.getContext('2d');
const viewport = document.getElementById('viewport');

let scale = 1, pX = 0, pY = 0;
let isDrawing = false, mode = 'draw';
let lastX = 0, lastY = 0;

function toggleEl(id) {
    const el = document.getElementById(id);
    el.style.display = (el.style.display === 'flex') ? 'none' : 'flex';
    if(id === 'gallery' && el.style.display === 'flex') window.loadGallery();
}

function setMode(m) { mode = m; toggleEl('tools'); }

function clearCanvas() {
    ctx.fillStyle = "#fff";
    ctx.fillRect(0,0,canvas.width,canvas.height);
}

function downloadImg() {
    const link = document.createElement('a');
    link.download = 'my-art.png';
    link.href = canvas.toDataURL();
    link.click();
}

function resetView() {
    scale = 0.4;
    pX = (viewport.clientWidth - canvas.width * scale) / 2;
    pY = 40;
    updateTransform();
}

function updateTransform() {
    canvas.style.transform = `translate(${pX}px, ${pY}px) scale(${scale})`;
}

function getPos(e) {
    const rect = viewport.getBoundingClientRect();
    const t = e.touches ? e.touches[0] : e;
    return {
        x: (t.clientX - rect.left - pX) / scale,
        y: (t.clientY - rect.top - pY) / scale
    };
}

let startDist = 0, startScale = 1, sX = 0, sY = 0;

viewport.addEventListener('touchstart', e => {
    if (e.touches.length === 2) {
        isDrawing = false;
        startDist = Math.hypot(e.touches[0].pageX - e.touches[1].pageX, e.touches[0].pageY - e.touches[1].pageY);
        startScale = scale;
        sX = (e.touches[0].pageX + e.touches[1].pageX) / 2 - pX;
        sY = (e.touches[0].pageY + e.touches[1].pageY) / 2 - pY;
    } else {
        isDrawing = true;
        const p = getPos(e);
        lastX = p.x; lastY = p.y;
        if(mode === 'fill') {
            ctx.fillStyle = `rgb(${document.getElementById('r').value},${document.getElementById('g').value},${document.getElementById('b').value})`;
            ctx.fillRect(0,0,canvas.width,canvas.height);
        }
    }
}, {passive: false});

viewport.addEventListener('touchmove', e => {
    e.preventDefault();
    if (e.touches.length === 2) {
        const dist = Math.hypot(e.touches[0].pageX - e.touches[1].pageX, e.touches[0].pageY - e.touches[1].pageY);
        scale = startScale * (dist / startDist);
        pX = (e.touches[0].pageX + e.touches[1].pageX) / 2 - sX;
        pY = (e.touches[0].pageY + e.touches[1].pageY) / 2 - sY;
        updateTransform();
    } else if (isDrawing) {
        const p = getPos(e);
        ctx.beginPath();
        ctx.globalCompositeOperation = (mode === 'erase') ? 'destination-out' : 'source-over';
        ctx.strokeStyle = `rgb(${document.getElementById('r').value},${document.getElementById('g').value},${document.getElementById('b').value})`;
        ctx.lineWidth = document.getElementById('size').value;
        ctx.lineCap = 'round'; ctx.lineJoin = 'round';
        ctx.moveTo(lastX, lastY);
        ctx.lineTo(p.x, p.y);
        ctx.stroke();
        lastX = p.x; lastY = p.y;
    }
}, {passive: false});

window.addEventListener('touchend', () => isDrawing = false);

clearCanvas();
setTimeout(resetView, 200);
</script>
</body>
</html>
