<!DOCTYPE html>
<html lang="ru">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
<title>Suno Global Canvas (Ultimate)</title>
<style>
/* --- 1. –û–°–ù–û–í–ù–û–ô –°–¢–ò–õ–¨ --- */
:root {
  --bg-color: #121212;
  --panel-bg: #222222;
  --btn-bg: #333333;
  --text-color: #f0f0f0;
  --accent: #008cff;
}

body {
  margin: 0; padding: 0;
  background: var(--bg-color);
  color: var(--text-color);
  font-family: sans-serif;
  height: 100vh;
  display: flex; flex-direction: column;
  overflow: hidden; /* –ë–ª–æ–∫–∏—Ä—É–µ–º —Å–∫—Ä–æ–ª–ª –≤—Å–µ–π —Å—Ç—Ä–∞–Ω–∏—Ü—ã */
}

/* --- 2. –í–ï–†–•–ù–Ø–Ø –ü–ê–ù–ï–õ–¨ --- */
#top-bar {
  background: var(--panel-bg);
  padding: 8px;
  display: flex; gap: 8px; align-items: center;
  border-bottom: 1px solid #444;
  overflow-x: auto; /* –ì–æ—Ä–∏–∑–æ–Ω—Ç–∞–ª—å–Ω—ã–π —Å–∫—Ä–æ–ª–ª –¥–ª—è –∫–Ω–æ–ø–æ–∫ */
  white-space: nowrap;
  flex-shrink: 0;
  z-index: 9999; /* –ü–æ–≤–µ—Ä—Ö –≤—Å–µ–≥–æ */
  height: 50px;
}

/* –°—Ç–∏–ª–∏ –ø–æ–ª–µ–π –≤–≤–æ–¥–∞ —Ä–∞–∑–º–µ—Ä–∞ */
.size-inputs {
  display: flex; align-items: center; gap: 5px;
}
.size-inputs input {
  width: 45px; background: #000; color: #fff;
  border: 1px solid #555; padding: 5px; text-align: center;
  border-radius: 4px;
}

button {
  background: var(--btn-bg); color: #fff;
  border: 1px solid #555; border-radius: 5px;
  padding: 8px 12px; font-size: 14px;
  cursor: pointer;
}
button:active { background: var(--accent); }

/* --- 3. –•–û–õ–°–¢ –ò –í–¨–Æ–ü–û–†–¢ --- */
#viewport {
  flex-grow: 1;
  position: relative;
  background: #181818;
  overflow: hidden;
  touch-action: none; /* –í–∞–∂–Ω–æ –¥–ª—è –∂–µ—Å—Ç–æ–≤ */
}

canvas {
  position: absolute;
  background: #fff;
  box-shadow: 0 0 20px rgba(0,0,0,0.5);
  transform-origin: 0 0;
}

/* --- 4. –í–°–ü–õ–´–í–ê–Æ–©–ò–ï –ü–ê–ù–ï–õ–ò --- */
.floating-panel {
  position: fixed; top: 70px;
  background: rgba(30,30,30,0.95);
  border: 1px solid #666; border-radius: 8px;
  padding: 15px;
  display: none; flex-direction: column; gap: 12px;
  z-index: 10000;
}
#tools-panel { left: 10px; }
#colors-panel { right: 10px; width: 220px; }

/* –ü–æ–ª–∑—É–Ω–∫–∏ –∏ –ø—Ä–µ–≤—å—é —Ü–≤–µ—Ç–∞ */
input[type=range] { width: 100%; height: 25px; }
#color-preview {
  width: 100%; height: 40px;
  border: 2px solid #fff; border-radius: 4px;
  margin-bottom: 5px;
  background: #000;
}

/* --- 5. –ì–ê–õ–ï–†–ï–Ø --- */
#gallery-overlay {
  position: fixed; top: 0; left: 0; right: 0; bottom: 0;
  background: #000;
  z-index: 20000;
  display: none; flex-direction: column;
  padding: 15px;
}
#gallery-content {
  margin-top: 15px;
  display: grid; grid-template-columns: repeat(auto-fill, minmax(130px, 1fr));
  gap: 10px; overflow-y: auto; height: 100%;
}
.art-card { background: #222; padding: 5px; border-radius: 6px; text-align: center; }
.art-card img { width: 100%; height: 120px; object-fit: contain; background: #000; }
.report-btn { margin-top: 5px; font-size: 10px; width: 100%; background: #442222; }

</style>
</head>
<body>

<div id="top-bar">
  <button onclick="toggle('tools-panel')">üõ† –ò–Ω—Å—Ç—Ä.</button>
  
  <div class="size-inputs">
    <span>W:</span><input type="number" id="inpW" value="360" onchange="resizeCanvas()">
    <span>H:</span><input type="number" id="inpH" value="500" onchange="resizeCanvas()">
  </div>

  <button onclick="toggle('colors-panel')">üé® –¶–≤–µ—Ç</button>
  <button onclick="toggleGallery()">üåç –ì–ª–æ–±–∞–ª—å–Ω–æ</button>
  <button onclick="saveToCloud()" style="border: 1px solid #008cff; color: #008cff;">‚òÅÔ∏è –ó–∞–ø—É—Å—Ç–∏—Ç—å</button>
  <button onclick="downloadImg()">üíæ –°–∫–∞—á–∞—Ç—å</button>
  <button onclick="resetView()">üéØ –¶–µ–Ω—Ç—Ä</button>
  <button onclick="clearCanvas()" style="color: #ff4444;">üóë</button>
</div>

<div id="tools-panel" class="floating-panel">
  <button onclick="setMode('draw')">‚úèÔ∏è –ö–∞—Ä–∞–Ω–¥–∞—à</button>
  <button onclick="setMode('erase')">üßΩ –õ–∞—Å—Ç–∏–∫</button>
  <button onclick="setMode('fill')">‚¨õ –ó–∞–ª–∏–≤–∫–∞</button>
  <hr style="width:100%; border:0; border-top:1px solid #555;">
  <button onclick="document.getElementById('fileIn').click()">üìÅ –ó–∞–≥—Ä—É–∑–∏—Ç—å —Ñ–æ—Ç–æ</button>
  <input type="file" id="fileIn" hidden accept="image/*" onchange="handleImage(event)">
</div>

<div id="colors-panel" class="floating-panel">
  <div id="color-preview"></div>
  <label>–†–∞–∑–º–µ—Ä –∫–∏—Å—Ç–∏: <span id="s_val">5</span></label>
  <input type="range" id="size" min="1" max="100" value="5" oninput="document.getElementById('s_val').innerText=this.value">
  <label>R (–ö—Ä–∞—Å–Ω—ã–π)</label><input type="range" id="r" max="255" value="0" oninput="updColor()">
  <label>G (–ó–µ–ª–µ–Ω—ã–π)</label><input type="range" id="g" max="255" value="0" oninput="updColor()">
  <label>B (–°–∏–Ω–∏–π)</label><input type="range" id="b" max="255" value="0" oninput="updColor()">
</div>

<div id="viewport">
  <canvas id="canvas" width="360" height="500"></canvas>
</div>

<div id="gallery-overlay">
  <button onclick="toggleGallery()">‚ùå –ó–∞–∫—Ä—ã—Ç—å –≥–∞–ª–µ—Ä–µ—é</button>
  <div id="gallery-content">–ó–∞–≥—Ä—É–∑–∫–∞...</div>
</div>

<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
import { getFirestore, collection, addDoc, getDocs, query, orderBy, limit, doc, updateDoc, increment, arrayUnion, deleteDoc } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

const firebaseConfig = {
    apiKey: "AIzaSyCekB6vZ6qGAnvDO1LOA7OUGmA3zU1aLoA",
    authDomain: "suno-gallery.firebaseapp.com",
    projectId: "suno-gallery",
    appId: "1:314284584278:web:97c5b91180562fd1c93af7"
};

let db, galleryRef;
try {
  const app = initializeApp(firebaseConfig);
  db = getFirestore(app);
  galleryRef = collection(db, "drawings");
} catch(e) { console.error("Firebase err:", e); }

// ID –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è (—á—Ç–æ–±—ã –≥–æ–ª–æ—Å–æ–≤–∞—Ç—å 1 —Ä–∞–∑)
let USER_ID = localStorage.getItem("u_id");
if(!USER_ID) {
  USER_ID = 'user_' + Date.now() + Math.random();
  localStorage.setItem("u_id", USER_ID);
}

// –ì–ª–æ–±–∞–ª—å–Ω–∞—è —Ñ—É–Ω–∫—Ü–∏—è —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è
window.saveToCloud = async () => {
    if(!db) return alert("–ù–µ—Ç —Å–æ–µ–¥–∏–Ω–µ–Ω–∏—è —Å –±–∞–∑–æ–π");
    if(!confirm("–û–ø—É–±–ª–∏–∫–æ–≤–∞—Ç—å —Ä–∏—Å—É–Ω–æ–∫ –≤ –≥–ª–æ–±–∞–ª—å–Ω—É—é –ª–µ–Ω—Ç—É?")) return;
    
    try {
        const dataUrl = document.getElementById('canvas').toDataURL('image/jpeg', 0.6);
        await addDoc(galleryRef, {
            image: dataUrl,
            date: Date.now(),
            reports: 0,
            reporters: []
        });
        alert("–£—Å–ø–µ—à–Ω–æ –æ–ø—É–±–ª–∏–∫–æ–≤–∞–Ω–æ!");
        window.toggleGallery();
    } catch(e) { alert("–û—à–∏–±–∫–∞: " + e.message); }
};

// –ì–ª–æ–±–∞–ª—å–Ω–∞—è —Ñ—É–Ω–∫—Ü–∏—è –∑–∞–≥—Ä—É–∑–∫–∏ –≥–∞–ª–µ—Ä–µ–∏
window.loadGlobalGallery = async () => {
    const box = document.getElementById("gallery-content");
    box.innerHTML = "–ó–∞–≥—Ä—É–∑–∫–∞ —Ä–∏—Å—É–Ω–∫–æ–≤...";
    
    if(!db) return;
    try {
        const q = query(galleryRef, orderBy("date", "desc"), limit(25));
        const snap = await getDocs(q);
        box.innerHTML = "";
        
        snap.forEach(d => {
            const data = d.data();
            const div = document.createElement("div");
            div.className = "art-card";
            div.innerHTML = `
                <img src="${data.image}">
                <button class="report-btn">–ü–æ–∂–∞–ª–æ–≤–∞—Ç—å—Å—è (${data.reports||0})</button>
            `;
            
            // –û–±—Ä–∞–±–æ—Ç–∫–∞ –∫–Ω–æ–ø–∫–∏ –∂–∞–ª–æ–±—ã
            const btn = div.querySelector("button");
            btn.onclick = async () => {
                if(data.reporters && data.reporters.includes(USER_ID)) {
                    alert("–í—ã —É–∂–µ –∂–∞–ª–æ–≤–∞–ª–∏—Å—å –Ω–∞ —ç—Ç–æ—Ç —Ä–∏—Å—É–Ω–æ–∫."); return;
                }
                if(!confirm("–ü–æ–∂–∞–ª–æ–≤–∞—Ç—å—Å—è –Ω–∞ –∫–æ–Ω—Ç–µ–Ω—Ç?")) return;
                
                const ref = doc(db, "drawings", d.id);
                // –ï—Å–ª–∏ 5 –∂–∞–ª–æ–± - —É–¥–∞–ª—è–µ–º
                if((data.reports || 0) >= 4) {
                    await deleteDoc(ref);
                    div.remove();
                } else {
                    await updateDoc(ref, {
                        reports: increment(1),
                        reporters: arrayUnion(USER_ID)
                    });
                    btn.innerText = "–ñ–∞–ª–æ–±–∞ –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω–∞";
                }
            };
            box.appendChild(div);
        });
    } catch(e) { box.innerHTML = "–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏: " + e.message; }
};
</script>

<script>
const canvas = document.getElementById("canvas");
const ctx = canvas.getContext("2d");
const viewport = document.getElementById("viewport");
const preview = document.getElementById("color-preview");

// –°–æ—Å—Ç–æ—è–Ω–∏–µ
let scale = 1, pX = 0, pY = 0; // –ö–∞–º–µ—Ä–∞
let mode = "draw"; // draw, erase, fill
let isDrawing = false;
let lastX = 0, lastY = 0;

// –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è
updColor();
setTimeout(resetView, 100);

// --- –§–£–ù–ö–¶–ò–ò –ò–ù–¢–ï–†–§–ï–ô–°–ê ---
function toggle(id) {
    const el = document.getElementById(id);
    document.querySelectorAll('.floating-panel').forEach(p => {
       if(p.id !== id) p.style.display = 'none';
    });
    el.style.display = (el.style.display === 'flex') ? 'none' : 'flex';
}

function toggleGallery() {
    const el = document.getElementById("gallery-overlay");
    const show = (el.style.display !== 'flex');
    el.style.display = show ? 'flex' : 'none';
    if(show && window.loadGlobalGallery) window.loadGlobalGallery();
}

function setMode(m) { mode = m; toggle('tools-panel'); }

function updColor() {
    const r = document.getElementById('r').value;
    const g = document.getElementById('g').value;
    const b = document.getElementById('b').value;
    preview.style.background = `rgb(${r},${g},${b})`;
}

function getColor() { return preview.style.background; }

function downloadImg() {
    const a = document.createElement('a');
    a.download = 'art_' + Date.now() + '.png';
    a.href = canvas.toDataURL();
    a.click();
}

function clearCanvas() {
    ctx.fillStyle = "#ffffff";
    ctx.fillRect(0,0,canvas.width,canvas.height);
}

function resizeCanvas() {
    const w = document.getElementById('inpW').value;
    const h = document.getElementById('inpH').value;
    // –°–æ—Ö—Ä–∞–Ω—è–µ–º —Ç–µ–∫—É—â–∏–π —Ä–∏—Å—É–Ω–æ–∫ –ø–µ—Ä–µ–¥ –∏–∑–º–µ–Ω–µ–Ω–∏–µ–º —Ä–∞–∑–º–µ—Ä–∞
    const temp = document.createElement('canvas');
    temp.width = canvas.width; temp.height = canvas.height;
    temp.getContext('2d').drawImage(canvas, 0, 0);
    
    canvas.width = w; canvas.height = h;
    clearCanvas(); // –ó–∞–ª–∏–≤–∞–µ–º –±–µ–ª—ã–º
    ctx.drawImage(temp, 0, 0); // –í–æ–∑–≤—Ä–∞—â–∞–µ–º —Ä–∏—Å—É–Ω–æ–∫
    resetView();
}

function handleImage(e) {
    const reader = new FileReader();
    reader.onload = function(event) {
        const img = new Image();
        img.onload = function() {
            clearCanvas();
            // –ú–∞—Å—à—Ç–∞–±–∏—Ä—É–µ–º –∫–∞—Ä—Ç–∏–Ω–∫—É, —á—Ç–æ–±—ã –≤–ª–µ–∑–ª–∞
            ctx.drawImage(img, 0, 0, canvas.width, canvas.height);
            toggle('tools-panel');
        }
        img.src = event.target.result;
    }
    reader.readAsDataURL(e.target.files[0]);
}

// --- –£–ü–†–ê–í–õ–ï–ù–ò–ï –ö–ê–ú–ï–†–û–ô (–ñ–ï–°–¢–´) ---
function resetView() {
    // –ê–≤—Ç–æ–∑—É–º, —á—Ç–æ–±—ã —Ö–æ–ª—Å—Ç —Ü–µ–ª–∏–∫–æ–º –≤–ª–µ–∑ –≤ —ç–∫—Ä–∞–Ω —Å –æ—Ç—Å—Ç—É–ø–æ–º
    const vW = viewport.clientWidth;
    const vH = viewport.clientHeight;
    scale = Math.min(vW / canvas.width, vH / canvas.height) * 0.9;
    pX = (vW - canvas.width * scale) / 2;
    pY = 20;
    updateTransform();
}

function updateTransform() {
    canvas.style.transform = `translate(${pX}px, ${pY}px) scale(${scale})`;
}

function getLocalCoords(e) {
    const rect = viewport.getBoundingClientRect();
    const t = e.touches ? e.touches[0] : e;
    return {
        x: (t.clientX - rect.left - pX) / scale,
        y: (t.clientY - rect.top - pY) / scale
    };
}

// --- –û–ë–†–ê–ë–û–¢–ß–ò–ö–ò TOUCH ---
let startDist = 0, startScale = 1;
let startX = 0, startY = 0; // –î–ª—è –ø–∞–Ω–æ—Ä–∞–º–∏—Ä–æ–≤–∞–Ω–∏—è

viewport.addEventListener('touchstart', e => {
    if(e.touches.length === 2) {
        // –î–í–ê –ü–ê–õ–¨–¶–ê = –ó–£–ú –ò –ü–ï–†–ï–ú–ï–©–ï–ù–ò–ï
        isDrawing = false;
        startDist = Math.hypot(
            e.touches[0].clientX - e.touches[1].clientX,
            e.touches[0].clientY - e.touches[1].clientY
        );
        startScale = scale;
        // –¶–µ–Ω—Ç—Ä –∂–µ—Å—Ç–∞
        startX = (e.touches[0].clientX + e.touches[1].clientX) / 2 - pX;
        startY = (e.touches[0].clientY + e.touches[1].clientY) / 2 - pY;
    } else if(e.touches.length === 1) {
        // –û–î–ò–ù –ü–ê–õ–ï–¶ = –†–ò–°–û–í–ê–ù–ò–ï
        isDrawing = true;
        const p = getLocalCoords(e);
        lastX = p.x; lastY = p.y;
        
        if(mode === 'fill') {
            ctx.fillStyle = getColor();
            ctx.fillRect(0,0,canvas.width, canvas.height);
        } else {
            // –¢–æ—á–∫–∞ –ø—Ä–∏ –Ω–∞–∂–∞—Ç–∏–∏
            ctx.beginPath();
            ctx.fillStyle = getColor();
            if(mode === 'erase') ctx.fillStyle = '#fff';
            ctx.arc(p.x, p.y, document.getElementById('size').value / 2, 0, Math.PI*2);
            ctx.fill();
        }
    }
}, {passive: false});

viewport.addEventListener('touchmove', e => {
    e.preventDefault(); // –ë–ª–æ–∫–∏—Ä—É–µ–º —Å–∫—Ä–æ–ª–ª –±—Ä–∞—É–∑–µ—Ä–∞

    if(e.touches.length === 2) {
        // –õ–æ–≥–∏–∫–∞ –∑—É–º–∞
        const dist = Math.hypot(
            e.touches[0].clientX - e.touches[1].clientX,
            e.touches[0].clientY - e.touches[1].clientY
        );
        scale = startScale * (dist / startDist);
        
        // –õ–æ–≥–∏–∫–∞ –ø–µ—Ä–µ–º–µ—â–µ–Ω–∏—è
        const curX = (e.touches[0].clientX + e.touches[1].clientX) / 2;
        const curY = (e.touches[0].clientY + e.touches[1].clientY) / 2;
        pX = curX - startX;
        pY = curY - startY;
        
        updateTransform();
    } 
    else if(isDrawing && e.touches.length === 1) {
        const p = getLocalCoords(e);
        
        ctx.beginPath();
        ctx.moveTo(lastX, lastY);
        ctx.lineTo(p.x, p.y);
        
        ctx.lineCap = "round";
        ctx.lineJoin = "round";
        ctx.lineWidth = document.getElementById('size').value;
        
        if(mode === 'erase') {
            ctx.globalCompositeOperation = 'destination-out'; // –ß–µ—Å—Ç–Ω—ã–π –ª–∞—Å—Ç–∏–∫ (–ø—Ä–æ–∑—Ä–∞—á–Ω–æ—Å—Ç—å)
            // –ù–æ —Ç–∞–∫ –∫–∞–∫ —É –Ω–∞—Å –±–µ–ª—ã–π —Ñ–æ–Ω, –ª—É—á—à–µ —Ä–∏—Å–æ–≤–∞—Ç—å –±–µ–ª—ã–º, –µ—Å–ª–∏ –Ω–µ –Ω—É–∂–µ–Ω PNG —Å –ø—Ä–æ–∑—Ä–∞—á–Ω–æ—Å—Ç—å—é
             ctx.globalCompositeOperation = 'source-over';
             ctx.strokeStyle = '#ffffff';
        } else {
            ctx.globalCompositeOperation = 'source-over';
            ctx.strokeStyle = getColor();
        }
        
        ctx.stroke();
        lastX = p.x; lastY = p.y;
    }
}, {passive: false});

window.addEventListener('touchend', () => {
    isDrawing = false;
});
</script>

</body>
  </html>
  
