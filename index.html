<!DOCTYPE html>
<html lang="ru">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
<title>Suno Global Canvas Pro</title>
<style>
:root {
  --bg-color: #121212; --panel-bg: #222222; --btn-bg: #333333; --text-color: #f0f0f0; --accent: #008cff;
}
body {
  margin: 0; padding: 0; background: var(--bg-color); color: var(--text-color);
  font-family: sans-serif; height: 100vh; display: flex; flex-direction: column; overflow: hidden;
}
#top-bar {
  background: var(--panel-bg); padding: 8px; display: flex; gap: 8px; align-items: center;
  border-bottom: 1px solid #444; overflow-x: auto; white-space: nowrap; flex-shrink: 0; z-index: 9999;
}
.size-inputs { display: flex; align-items: center; gap: 5px; }
.size-inputs input { width: 45px; background: #000; color: #fff; border: 1px solid #555; border-radius: 4px; padding: 5px; }
button { background: var(--btn-bg); color: #fff; border: 1px solid #555; border-radius: 5px; padding: 8px 12px; font-size: 14px; }
button:disabled { opacity: 0.3; }
#viewport { flex-grow: 1; position: relative; background: #181818; overflow: hidden; touch-action: none; }
canvas { position: absolute; background: #fff; transform-origin: 0 0; }
.floating-panel {
  position: fixed; top: 70px; background: rgba(30,30,30,0.95); border: 1px solid #666;
  border-radius: 8px; padding: 15px; display: none; flex-direction: column; gap: 12px; z-index: 10000;
}
#color-preview { width: 100%; height: 40px; border: 2px solid #fff; border-radius: 4px; background: #000; }
input[type=range] { width: 100%; height: 25px; }
#gallery-overlay { position: fixed; inset: 0; background: #000; z-index: 20000; display: none; flex-direction: column; padding: 15px; }
#gallery-content { margin-top: 15px; display: grid; grid-template-columns: repeat(auto-fill, minmax(130px, 1fr)); gap: 10px; overflow-y: auto; }
.art-card { background: #222; padding: 5px; border-radius: 6px; text-align: center; }
.art-card img { width: 100%; height: 120px; object-fit: contain; }
</style>
</head>
<body>

<div id="top-bar">
  <button onclick="undo()">‚Ü©Ô∏è</button>
  <button onclick="redo()">‚Ü™Ô∏è</button>
  <button onclick="toggle('tools-panel')">üõ†</button>
  <div class="size-inputs">
    <input type="number" id="inpW" value="360" onchange="resizeCanvas()">
    <input type="number" id="inpH" value="500" onchange="resizeCanvas()">
  </div>
  <button onclick="toggle('colors-panel')">üé®</button>
  <button onclick="toggleGallery()">üåç –ì–ª–æ–±–∞–ª—å–Ω–æ</button>
  <button onclick="saveToCloud()" style="color:var(--accent)">‚òÅÔ∏è –ó–∞–ø—É—Å—Ç–∏—Ç—å</button>
  <button onclick="downloadImg()">üíæ</button>
  <button onclick="resetView()">üéØ</button>
  <button onclick="clearCanvas()" style="color:red">üóë</button>
</div>

<div id="tools-panel" class="floating-panel" style="left:10px">
  <button onclick="setMode('draw')">‚úèÔ∏è –ö–∏—Å—Ç—å</button>
  <button onclick="setMode('erase')">üßΩ –õ–∞—Å—Ç–∏–∫</button>
  <button onclick="setMode('fill')">‚¨õ –ó–∞–ª–∏–≤–∫–∞</button>
  <button onclick="document.getElementById('fileIn').click()">üìÅ –§–æ—Ç–æ</button>
  <input type="file" id="fileIn" hidden accept="image/*" onchange="handleImage(event)">
</div>

<div id="colors-panel" class="floating-panel" style="right:10px; width:200px">
  <div id="color-preview"></div>
  <input type="range" id="size" min="1" max="100" value="5">
  <input type="range" id="r" max="255" value="0" oninput="updColor()">
  <input type="range" id="g" max="255" value="0" oninput="updColor()">
  <input type="range" id="b" max="255" value="0" oninput="updColor()">
</div>

<div id="viewport">
  <canvas id="canvas" width="360" height="500"></canvas>
</div>

<div id="gallery-overlay">
  <button onclick="toggleGallery()">‚ùå –ó–∞–∫—Ä—ã—Ç—å</button>
  <div id="gallery-content"></div>
</div>

<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
import { getFirestore, collection, addDoc, getDocs, query, orderBy, limit, doc, updateDoc, increment, arrayUnion } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

const firebaseConfig = {
    apiKey: "AIzaSyCekB6vZ6qGAnvDO1LOA7OUGmA3zU1aLoA",
    authDomain: "suno-gallery.firebaseapp.com",
    projectId: "suno-gallery",
    appId: "1:314284584278:web:97c5b91180562fd1c93af7"
};

const app = initializeApp(firebaseConfig);
const db = getFirestore(app);
const galleryRef = collection(db, "drawings");
let USER_ID = localStorage.getItem("u_id") || ('u'+Math.random());
localStorage.setItem("u_id", USER_ID);

let localReported = new Set(); // –ë–∞–≥-—Ñ–∏–∫—Å: –ª–æ–∫–∞–ª—å–Ω—ã–π —Å–ø–∏—Å–æ–∫ –∂–∞–ª–æ–±

window.saveToCloud = async () => {
    if(!confirm("–û–ø—É–±–ª–∏–∫–æ–≤–∞—Ç—å?")) return;
    try {
        await addDoc(galleryRef, { image: canvas.toDataURL('image/jpeg', 0.6), date: Date.now(), reports: 0, reporters: [] });
        alert("–û–ø—É–±–ª–∏–∫–æ–≤–∞–Ω–æ!");
    } catch(e) { alert("–û—à–∏–±–∫–∞"); }
};

window.loadGlobalGallery = async () => {
    const box = document.getElementById("gallery-content");
    box.innerHTML = "–ó–∞–≥—Ä—É–∑–∫–∞...";
    const snap = await getDocs(query(galleryRef, orderBy("date", "desc"), limit(20)));
    box.innerHTML = "";
    snap.forEach(d => {
        const data = d.data();
        const isReported = localReported.has(d.id) || (data.reporters && data.reporters.includes(USER_ID));
        const div = document.createElement("div");
        div.className = "art-card";
        div.innerHTML = `<img src="${data.image}"><button ${isReported?'disabled':''} class="report-btn">${isReported?'–£–∂–µ –∂–∞–ª–æ–≤–∞–ª–∏—Å—å':'–ñ–∞–ª–æ–±–∞'} (${data.reports||0})</button>`;
        div.querySelector("button").onclick = async (e) => {
            if(!confirm("–ü–æ–∂–∞–ª–æ–≤–∞—Ç—å—Å—è?")) return;
            await updateDoc(doc(db, "drawings", d.id), { reports: increment(1), reporters: arrayUnion(USER_ID) });
            localReported.add(d.id);
            e.target.disabled = true;
            e.target.innerText = "–û—Ç–ø—Ä–∞–≤–ª–µ–Ω–æ";
        };
        box.appendChild(div);
    });
};
</script>

<script>
const canvas = document.getElementById("canvas");
const ctx = canvas.getContext("2d");
const viewport = document.getElementById("viewport");
const preview = document.getElementById("color-preview");

let scale = 1, pX = 0, pY = 0, mode = "draw", isDrawing = false, lastX = 0, lastY = 0;

// Undo/Redo —Å–∏—Å—Ç–µ–º–∞
let history = [];
let historyStep = -1;

function saveHistory() {
    historyStep++;
    if (historyStep < history.length) history.length = historyStep;
    history.push(canvas.toDataURL());
    if (history.length > 20) { history.shift(); historyStep--; }
}

function undo() {
    if (historyStep > 0) {
        historyStep--;
        let img = new Image();
        img.onload = () => { ctx.fillStyle = "#fff"; ctx.fillRect(0,0,canvas.width,canvas.height); ctx.drawImage(img, 0, 0); };
        img.src = history[historyStep];
    }
}

function redo() {
    if (historyStep < history.length - 1) {
        historyStep++;
        let img = new Image();
        img.onload = () => { ctx.fillStyle = "#fff"; ctx.fillRect(0,0,canvas.width,canvas.height); ctx.drawImage(img, 0, 0); };
        img.src = history[historyStep];
    }
}

function updColor() {
    preview.style.background = `rgb(${document.getElementById('r').value},${document.getElementById('g').value},${document.getElementById('b').value})`;
}

function toggle(id) {
    const el = document.getElementById(id);
    el.style.display = (el.style.display === 'flex') ? 'none' : 'flex';
}

function toggleGallery() {
    toggle("gallery-overlay");
    if(document.getElementById("gallery-overlay").style.display === 'flex') window.loadGlobalGallery();
}

function setMode(m) { mode = m; toggle('tools-panel'); }

function clearCanvas() { 
    ctx.fillStyle = "#ffffff"; ctx.fillRect(0,0,canvas.width,canvas.height); 
    saveHistory();
}

function resizeCanvas() {
    const w = document.getElementById('inpW').value, h = document.getElementById('inpH').value;
    const temp = canvas.toDataURL();
    canvas.width = w; canvas.height = h;
    const img = new Image();
    img.onload = () => { ctx.fillStyle = "#fff"; ctx.fillRect(0,0,w,h); ctx.drawImage(img, 0, 0); saveHistory(); };
    img.src = temp;
    resetView();
}

function handleImage(e) {
    const reader = new FileReader();
    reader.onload = (ev) => {
        const img = new Image();
        img.onload = () => { ctx.drawImage(img, 0, 0, canvas.width, canvas.height); saveHistory(); };
        img.src = ev.target.result;
    };
    reader.readAsDataURL(e.target.files[0]);
}

function resetView() {
    scale = Math.min(viewport.clientWidth / canvas.width, viewport.clientHeight / canvas.height) * 0.9;
    pX = (viewport.clientWidth - canvas.width * scale) / 2; pY = 20;
    updateTransform();
}

function updateTransform() { canvas.style.transform = `translate(${pX}px, ${pY}px) scale(${scale})`; }

function getPos(e) {
    const rect = viewport.getBoundingClientRect();
    const t = e.touches ? e.touches[0] : e;
    return { x: (t.clientX - rect.left - pX) / scale, y: (t.clientY - rect.top - pY) / scale };
}

let sD = 0, sS = 1, sX = 0, sY = 0;
viewport.addEventListener('touchstart', e => {
    if(e.touches.length === 2) {
        isDrawing = false;
        sD = Math.hypot(e.touches[0].clientX - e.touches[1].clientX, e.touches[0].clientY - e.touches[1].clientY);
        sS = scale; sX = (e.touches[0].clientX + e.touches[1].clientX) / 2 - pX; sY = (e.touches[0].clientY + e.touches[1].clientY) / 2 - pY;
    } else {
        isDrawing = true;
        const p = getPos(e); lastX = p.x; lastY = p.y;
        if(mode === 'fill') { ctx.fillStyle = preview.style.background; ctx.fillRect(0,0,canvas.width,canvas.height); saveHistory(); }
    }
}, {passive: false});

viewport.addEventListener('touchmove', e => {
    e.preventDefault();
    if(e.touches.length === 2) {
        const d = Math.hypot(e.touches[0].clientX - e.touches[1].clientX, e.touches[0].clientY - e.touches[1].clientY);
        scale = sS * (d / sD);
        pX = (e.touches[0].clientX + e.touches[1].clientX) / 2 - sX;
        pY = (e.touches[0].clientY + e.touches[1].clientY) / 2 - sY;
        updateTransform();
    } else if(isDrawing) {
        const p = getPos(e);
        ctx.beginPath(); ctx.moveTo(lastX, lastY); ctx.lineTo(p.x, p.y);
        ctx.lineCap = "round"; ctx.lineWidth = document.getElementById('size').value;
        ctx.strokeStyle = (mode === 'erase') ? '#ffffff' : preview.style.background;
        ctx.stroke(); lastX = p.x; lastY = p.y;
    }
}, {passive: false});

window.addEventListener('touchend', () => { if(isDrawing) saveHistory(); isDrawing = false; });

// –°—Ç–∞—Ä—Ç
ctx.fillStyle = "#fff"; ctx.fillRect(0,0,360,500);
saveHistory();
updColor();
setTimeout(resetView, 200);
</script>
</body>
</html>
