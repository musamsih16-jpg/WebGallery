<!DOCTYPE html>
<html lang="ru">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
<title>Suno Global Canvas (Pro Zoom)</title>
<style>
/* --- 1. –°–¢–ò–õ–¨ (–¢–ï–ú–ù–´–ô, –°–û–í–†–ï–ú–ï–ù–ù–´–ô) --- */
:root {
  --main-bg: #121212;
  --top-bar-bg: #222222;
  --control-bg: #333333;
  --accent-color: #008cff;
  --text-color: #f0f0f0;
  --border-color: #555;
  --danger-color: #ff3b30;
}

body {
  margin: 0;
  background: var(--main-bg);
  color: var(--text-color);
  font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
  overflow: hidden; /* –í–∞–∂–Ω–æ: –æ—Ç–∫–ª—é—á–∞–µ–º —Å–∫—Ä–æ–ª–ª –≤—Å–µ–π —Å—Ç—Ä–∞–Ω–∏—Ü—ã */
  touch-action: none; /* –û—Ç–∫–ª—é—á–∞–µ–º —Å—Ç–∞–Ω–¥–∞—Ä—Ç–Ω—ã–µ –∂–µ—Å—Ç—ã –±—Ä–∞—É–∑–µ—Ä–∞ */
}

/* –í–µ—Ä—Ö–Ω—è—è –ø–∞–Ω–µ–ª—å */
#top {
  background: var(--top-bar-bg);
  padding: 8px;
  display: flex;
  flex-wrap: nowrap; /* –í –æ–¥–Ω—É —Å—Ç—Ä–æ–∫—É —Å –ø—Ä–æ–∫—Ä—É—Ç–∫–æ–π */
  gap: 8px;
  align-items: center;
  border-bottom: 1px solid var(--border-color);
  overflow-x: auto;
  position: absolute; /* –§–∏–∫—Å–∏—Ä—É–µ–º —Å–≤–µ—Ä—Ö—É */
  top: 0;
  left: 0;
  right: 0;
  height: 60px;
  z-index: 100;
  box-sizing: border-box;
}

/* –°–∫—Ä—ã–≤–∞–µ–º —Å–∫—Ä–æ–ª–ª–±–∞—Ä –º–µ–Ω—é, –Ω–æ –æ—Å—Ç–∞–≤–ª—è–µ–º –ø—Ä–æ–∫—Ä—É—Ç–∫—É */
#top::-webkit-scrollbar { display: none; }

button, input:not([type=range]) {
  background: var(--control-bg);
  color: var(--text-color);
  border: 1px solid var(--border-color);
  border-radius: 4px;
  padding: 8px 12px;
  font-size: 14px;
  cursor: pointer;
  flex-shrink: 0; /* –ß—Ç–æ–±—ã –∫–Ω–æ–ø–∫–∏ –Ω–µ —Å–∂–∏–º–∞–ª–∏—Å—å */
}
button:hover { background: #4a4a4a; border-color: var(--accent-color); }
.danger-btn { border-color: var(--danger-color) !important; color: var(--danger-color) !important; }

/* –ü–æ–ª–∑—É–Ω–∫–∏ */
input[type=range] {
  -webkit-appearance: none;
  background: var(--border-color);
  height: 6px;
  border-radius: 4px;
  width: 100%;
  margin: 5px 0;
}
input[type=range]::-webkit-slider-thumb {
  -webkit-appearance: none;
  width: 20px;
  height: 20px;
  border-radius: 50%;
  background: var(--accent-color);
  cursor: pointer;
  border: 2px solid #fff;
}

.control-group {
  display: flex;
  align-items: center;
  gap: 5px;
  flex-shrink: 0;
}
.control-group input[type=number] { width: 50px; text-align: center; padding: 5px; }


/* --- 2. –ì–õ–ê–í–ù–ê–Ø –û–ë–õ–ê–°–¢–¨ (VIEWPORT) --- */
#viewport {
    position: absolute;
    top: 60px; /* –í—ã—Å–æ—Ç–∞ —Ö–µ–¥–µ—Ä–∞ */
    bottom: 0;
    left: 0;
    right: 0;
    background: #1a1a1a;
    overflow: hidden; /* –°–∫—Ä—ã–≤–∞–µ–º –≤—ã–ª–µ–∑–∞—é—â–∏–π —Ö–æ–ª—Å—Ç */
    display: flex;
    justify-content: center;
    align-items: center;
    touch-action: none;
}

/* –•–æ–ª—Å—Ç */
canvas {
  display: block;
  background: #fff;
  box-shadow: 0 0 30px rgba(0,0,0,0.5);
  /* –¢—Ä–∞–Ω—Å—Ñ–æ—Ä–º–∞—Ü–∏—è –ø—Ä–æ–∏—Å—Ö–æ–¥–∏—Ç —á–µ—Ä–µ–∑ JS */
  transform-origin: 0 0; 
}


/* --- 3. –ò–ù–°–¢–†–£–ú–ï–ù–¢–´ –ò –¶–í–ï–¢–ê --- */
#tools {
  position: absolute;
  left: 10px;
  top: 70px;
  width: 50px;
  background: var(--control-bg);
  padding: 10px 5px;
  border: 1px solid var(--border-color);
  border-radius: 8px;
  display: none;
  flex-direction: column;
  gap: 15px;
  align-items: center;
  z-index: 50;
  box-shadow: 0 4px 10px rgba(0,0,0,0.3);
}

.tool-button {
  font-size: 24px;
  background: transparent;
  border: none;
  padding: 5px;
}
.tool-button.active {
    color: var(--accent-color);
    text-shadow: 0 0 8px var(--accent-color);
    transform: scale(1.1);
}

#color-panel {
    display: none;
    position: absolute;
    right: 10px;
    top: 70px;
    width: 240px;
    background: rgba(30, 30, 30, 0.95);
    backdrop-filter: blur(10px);
    padding: 15px;
    border: 1px solid var(--border-color);
    border-radius: 8px;
    flex-direction: column;
    gap: 10px;
    z-index: 50;
    max-height: calc(100vh - 100px);
    overflow-y: auto;
    box-shadow: 0 4px 15px rgba(0,0,0,0.5);
}

.rgb-slider-group {
    margin-bottom: 8px;
}
.rgb-slider-group label {
    display: flex;
    justify-content: space-between;
    font-size: 12px;
    color: #ccc;
    margin-bottom: 2px;
}

#colorPreview {
    height: 30px;
    width: 100%;
    border-radius: 4px;
    border: 1px solid #fff;
    margin-bottom: 10px;
}

/* --- 4. –ì–ê–õ–ï–†–ï–Ø --- */
#gallery { 
  position: fixed; top: 0; left: 0; right: 0; bottom: 0;
  background: rgba(0,0,0,0.95); 
  padding: 20px; 
  display: none; 
  flex-direction: column;
  overflow-y: auto; 
  z-index: 2000;
}
.gallery-grid {
    display: grid;
    grid-template-columns: repeat(auto-fill, minmax(140px, 1fr));
    gap: 15px;
    padding-bottom: 50px;
}
.gallery-item {
    background: #222;
    padding: 10px;
    border-radius: 8px;
    text-align: center;
}
.gallery-item img { 
    width: 100%;
    height: 120px;
    object-fit: contain;
    background: #333;
    border-radius: 4px;
}

#loader { color: #0f0; font-weight: bold; margin-left: 10px; display: none; font-size: 12px;}
</style>
</head>
<body>

<div id="top">
  <button onclick="window.toggleToolsPanel()">üõ† –ò–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç—ã</button>
  <button onclick="window.toggleColorPanel()">üé® –¶–≤–µ—Ç/–†–∞–∑–º–µ—Ä</button>
  <button onclick="window.toggleGallery()">üåç –ì–∞–ª–µ—Ä–µ—è</button>
  <div style="width: 1px; height: 30px; background: #555; margin: 0 5px;"></div>
  <button onclick="window.saveToFirebase()" style="color: var(--danger-color);">‚òÅÔ∏è –ü—É–±–ª–∏–∫–∞—Ü–∏—è</button>
  <button onclick="window.downloadCanvas()">üíæ –°–æ—Ö—Ä–∞–Ω–∏—Ç—å</button>
  <button onclick="window.clearCanvas()" class="danger-btn">üóë</button>
  <span id="loader">–ó–∞–≥—Ä—É–∑–∫–∞...</span>

    <div class="control-group">
        <label>W:</label>
        <input type="number" id="canvasW" value="360" onchange="window.resizeCanvas()">
    </div>
    <div class="control-group">
        <label>H:</label>
        <input type="number" id="canvasH" value="500" onchange="window.resizeCanvas()">
    </div>
</div>

<div id="tools">
    <button class="tool-button active" onclick="window.setMode('draw', this)">‚úèÔ∏è</button>
    <button class="tool-button" onclick="window.setMode('erase', this)">üßΩ</button>
    <button class="tool-button" onclick="window.setMode('fill', this)">‚¨õ</button>
    <button class="tool-button" onclick="window.resetView()">üéØ</button> </div>

<div id="color-panel">
    <div style="display:flex; justify-content:space-between; align-items:center;">
        <h3 style="margin:0; font-size:16px;">–ù–∞—Å—Ç—Ä–æ–π–∫–∏</h3>
        <button onclick="window.toggleColorPanel()" style="padding:2px 8px;">‚úï</button>
    </div>
    <hr style="border-color:#444; margin:10px 0;">

    <div id="colorPreview"></div>
    
    <div class="rgb-slider-group">
        <label>R: <span id="r_val">0</span></label>
        <input type="range" id="r" min="0" max="255" value="0" oninput="window.updateColorPreview()">
    </div>
    <div class="rgb-slider-group">
        <label>G: <span id="g_val">0</span></label>
        <input type="range" id="g" min="0" max="255" value="0" oninput="window.updateColorPreview()">
    </div>
    <div class="rgb-slider-group">
        <label>B: <span id="b_val">0</span></label>
        <input type="range" id="b" min="0" max="255" value="0" oninput="window.updateColorPreview()">
    </div>
    
    <hr style="border-color: #444; margin: 10px 0;">

    <div class="rgb-slider-group">
        <label>–†–∞–∑–º–µ—Ä –∫–∏—Å—Ç–∏: <span id="size_val">5</span></label>
        <input type="range" id="size" min="1" max="80" value="5" oninput="document.getElementById('size_val').textContent = this.value;">
    </div>
</div>

<div id="viewport">
    <canvas id="canvas" width="360" height="500"></canvas>
</div>

<div id="gallery">
    <div class="gallery-header" style="display:flex; justify-content:space-between; align-items:center; margin-bottom:15px;">
        <h2 style="margin:0;">üåç –ì–ª–æ–±–∞–ª—å–Ω–∞—è –ì–∞–ª–µ—Ä–µ—è</h2>
        <button onclick="window.toggleGallery()">‚ùå –ó–∞–∫—Ä—ã—Ç—å</button>
    </div>
    <div id="galleryContent" class="gallery-grid"></div>
</div>

<script type="module">
  import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
  import { getFirestore, collection, addDoc, getDocs, query, orderBy, limit, doc, updateDoc, increment, deleteDoc, arrayUnion } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";
  
  const firebaseConfig = {
    apiKey: "AIzaSyCekB6vZ6qGAnvDO1LOA7OUGmA3zU1aLoA",
    authDomain: "suno-gallery.firebaseapp.com",
    projectId: "suno-gallery",
    storageBucket: "suno-gallery.firebasestorage.app",
    messagingSenderId: "314284584278",
    appId: "1:314284584278:web:97c5b91180562fd1c93af7",
    measurementId: "G-2J4PNZX4CV"
  };

  const app = initializeApp(firebaseConfig);
  const db = getFirestore(app);
  const galleryRef = collection(db, "drawings"); 

  let USER_ID = localStorage.getItem("user_id");
  if (!USER_ID) {
      USER_ID = 'user_' + Math.random().toString(36).substring(2, 15);
      localStorage.setItem("user_id", USER_ID);
  }

  // –≠–ª–µ–º–µ–Ω—Ç—ã
  const canvas = document.getElementById("canvas");
  const ctx = canvas.getContext("2d");
  const viewport = document.getElementById("viewport");
  
  const colorPreview = document.getElementById("colorPreview");
  const rEl = document.getElementById("r");
  const gEl = document.getElementById("g");
  const bEl = document.getElementById("b");
  const sizeEl = document.getElementById("size");
  const loader = document.getElementById("loader");
  const toolButtons = document.querySelectorAll('.tool-button');

  // –°–æ—Å—Ç–æ—è–Ω–∏–µ
  window.mode = "draw";
  
  // --- –ü–ï–†–ï–ú–ï–ù–ù–´–ï –î–õ–Ø –ó–£–ú–ê –ò –ü–ê–ù–ê (IBIS STYLE) ---
  let scale = 1;
  let panning = false;
  let pointX = 0;
  let pointY = 0;
  let startX = 0;
  let startY = 0;
  let lastX = 0;
  let lastY = 0;
  let isGesture = false;
  let startDist = 0;
  let startScale = 1;

  // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –ø–æ–∑–∏—Ü–∏–∏ —Ö–æ–ª—Å—Ç–∞ –ø–æ —Ü–µ–Ω—Ç—Ä—É
  function centerCanvas() {
      const vw = viewport.clientWidth;
      const vh = viewport.clientHeight;
      pointX = (vw - canvas.width) / 2;
      pointY = (vh - canvas.height) / 2;
      updateTransform();
  }
  
  window.resetView = () => {
      scale = 1;
      centerCanvas();
  }

  // --- –ò–ù–¢–ï–†–§–ï–ô–° ---

  window.toggleToolsPanel = () => {
      const el = document.getElementById("tools");
      el.style.display = (getComputedStyle(el).display === "flex") ? "none" : "flex";
  }
  
  window.toggleColorPanel = () => {
      const el = document.getElementById("color-panel");
      el.style.display = (getComputedStyle(el).display === "flex") ? "none" : "flex";
  }

  window.toggleGallery = () => {
    const g = document.getElementById("gallery");
    if (getComputedStyle(g).display === "none") {
        g.style.display = "flex";
        loadGlobalGallery(); 
    } else {
        g.style.display = "none";
    }
  };
  
  window.setMode = (newMode, btn) => {
      window.mode = newMode;
      toolButtons.forEach(button => button.classList.remove('active'));
      if(btn) btn.classList.add('active');
  }

  window.updateColorPreview = () => {
    const r = rEl.value;
    const g = gEl.value;
    const b = bEl.value;
    colorPreview.style.backgroundColor = `rgb(${r},${g},${b})`;
    document.getElementById('r_val').textContent = r;
    document.getElementById('g_val').textContent = g;
    document.getElementById('b_val').textContent = b;
  };

  function getColor() {
    return `rgb(${rEl.value},${gEl.value},${bEl.value})`;
  }

  // --- –§–ò–ö–° –ü–û–õ–ó–£–ù–ö–û–í ---
  // –ú—ã –∏—Å–ø–æ–ª—å–∑—É–µ–º stopPropagation, —á—Ç–æ–±—ã —Å–æ–±—ã—Ç–∏—è –Ω–µ –¥–æ—Ö–æ–¥–∏–ª–∏ –¥–æ –≤—å—é–ø–æ—Ä—Ç–∞ –∏ –Ω–µ –≤—ã–∑—ã–≤–∞–ª–∏ —Ä–∏—Å–æ–≤–∞–Ω–∏–µ
  document.querySelectorAll('input[type="range"]').forEach(slider => {
      slider.addEventListener('touchstart', (e) => e.stopPropagation(), {passive: false});
      slider.addEventListener('touchmove', (e) => e.stopPropagation(), {passive: false});
  });

  window.resizeCanvas = () => {
      const w = parseInt(document.getElementById('canvasW').value) || 360;
      const h = parseInt(document.getElementById('canvasH').value) || 500;
      
      const tempCanvas = document.createElement('canvas');
      tempCanvas.width = canvas.width;
      tempCanvas.height = canvas.height;
      tempCanvas.getContext('2d').drawImage(canvas, 0, 0);

      canvas.width = w;
      canvas.height = h;
      
      ctx.drawImage(tempCanvas, 0, 0);
      centerCanvas(); // –¶–µ–Ω—Ç—Ä–∏—Ä—É–µ–º –ø–æ—Å–ª–µ —Ä–µ—Å–∞–π–∑–∞
  }

  window.downloadCanvas = () => {
    const link = document.createElement('a');
    link.download = 'suno_art.png';
    link.href = canvas.toDataURL("image/png");
    link.click();
  }

  // --- –õ–û–ì–ò–ö–ê –ñ–ï–°–¢–û–í –ò –†–ò–°–û–í–ê–ù–ò–Ø ---

  function updateTransform() {
      // –ü—Ä–∏–º–µ–Ω—è–µ–º CSS —Ç—Ä–∞–Ω—Å—Ñ–æ—Ä–º–∞—Ü–∏—é –∫ —Ö–æ–ª—Å—Ç—É
      canvas.style.transform = `translate(${pointX}px, ${pointY}px) scale(${scale})`;
  }

  // –ü–æ–ª—É—á–∏—Ç—å –∫–æ–æ—Ä–¥–∏–Ω–∞—Ç—ã —Ä–∏—Å–æ–≤–∞–Ω–∏—è –Ω–∞ —Ö–æ–ª—Å—Ç–µ —Å —É—á–µ—Ç–æ–º –∑—É–º–∞ –∏ —Å–¥–≤–∏–≥–∞
  function getPaintPosition(e) {
      // –ö–æ–æ—Ä–¥–∏–Ω–∞—Ç—ã –∫–ª–∏–∫–∞ –æ—Ç–Ω–æ—Å–∏—Ç–µ–ª—å–Ω–æ Viewport (–∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–∞)
      const rect = viewport.getBoundingClientRect();
      const clientX = e.touches ? e.touches[0].clientX : e.clientX;
      const clientY = e.touches ? e.touches[0].clientY : e.clientY;
      
      const viewX = clientX - rect.left;
      const viewY = clientY - rect.top;

      // –ú–∞—Ç–µ–º–∞—Ç–∏–∫–∞ –æ–±—Ä–∞—Ç–Ω–æ–π —Ç—Ä–∞–Ω—Å—Ñ–æ—Ä–º–∞—Ü–∏–∏:
      // (–ö–æ–æ—Ä–¥–∏–Ω–∞—Ç–∞–í—å—é–ø–æ—Ä—Ç–∞ - –°–¥–≤–∏–≥) / –ú–∞—Å—à—Ç–∞–± = –ö–æ–æ—Ä–¥–∏–Ω–∞—Ç–∞–•–æ–ª—Å—Ç–∞
      return {
          x: (viewX - pointX) / scale,
          y: (viewY - pointY) / scale
      };
  }
  
  function getDistance(touches) {
      return Math.hypot(
          touches[0].clientX - touches[1].clientX,
          touches[0].clientY - touches[1].clientY
      );
  }
  
  function getMidpoint(touches) {
      return {
          x: (touches[0].clientX + touches[1].clientX) / 2,
          y: (touches[0].clientY + touches[1].clientY) / 2
      };
  }

  // –°–æ–±—ã—Ç–∏—è –≤–µ—à–∞–µ–º –Ω–∞ Viewport, —Ç–∞–∫ –∫–∞–∫ –æ–Ω –∑–∞–Ω–∏–º–∞–µ—Ç –≤–µ—Å—å —ç–∫—Ä–∞–Ω
  viewport.addEventListener('mousedown', onPointerDown);
  viewport.addEventListener('touchstart', onPointerDown, {passive: false});
  
  viewport.addEventListener('mousemove', onPointerMove);
  viewport.addEventListener('touchmove', onPointerMove, {passive: false});
  
  viewport.addEventListener('mouseup', onPointerUp);
  viewport.addEventListener('touchend', onPointerUp);
  viewport.addEventListener('mouseleave', onPointerUp);

  function onPointerDown(e) {
      // –ï—Å–ª–∏ 2 –ø–∞–ª—å—Ü–∞ - –Ω–∞—á–∞–ª–æ –∂–µ—Å—Ç–∞
      if (e.touches && e.touches.length === 2) {
          isGesture = true;
          startDist = getDistance(e.touches);
          startScale = scale;
          
          const mid = getMidpoint(e.touches);
          startX = mid.x - pointX; // –ó–∞–ø–æ–º–∏–Ω–∞–µ–º —Å–º–µ—â–µ–Ω–∏–µ –æ—Ç–Ω–æ—Å–∏—Ç–µ–ª—å–Ω–æ —Ç–µ–∫—É—â–µ–π –ø–æ–∑–∏—Ü–∏–∏
          startY = mid.y - pointY;
          return;
      }

      // –ï—Å–ª–∏ 1 –ø–∞–ª–µ—Ü/–º—ã—à—å - –†–∏—Å–æ–≤–∞–Ω–∏–µ
      if ((!e.touches || e.touches.length === 1) && !isGesture) {
          if (window.mode === 'fill') {
               ctx.fillStyle = getColor();
               ctx.fillRect(0,0,canvas.width,canvas.height);
               return;
          }
          
          window.drawing = true;
          const p = getPaintPosition(e);
          ctx.beginPath();
          ctx.moveTo(p.x, p.y);
          lastX = p.x;
          lastY = p.y;
      }
  }

  function onPointerMove(e) {
      e.preventDefault(); // –ë–ª–æ–∫–∏—Ä—É–µ–º —Å–∫—Ä–æ–ª–ª —Å—Ç—Ä–∞–Ω–∏—Ü—ã

      // –õ–æ–≥–∏–∫–∞ 2 –ø–∞–ª—å—Ü–µ–≤ (–ó—É–º –∏ –ü–∞–Ω)
      if (e.touches && e.touches.length === 2) {
          isGesture = true;
          window.drawing = false; // –ü—Ä–µ–∫—Ä–∞—â–∞–µ–º —Ä–∏—Å–æ–≤–∞—Ç—å

          // 1. Zoom
          const newDist = getDistance(e.touches);
          const scaleMultiplier = newDist / startDist;
          let newScale = startScale * scaleMultiplier;
          
          // –û–≥—Ä–∞–Ω–∏—á–∏—Ç–µ–ª–∏ –∑—É–º–∞
          if (newScale < 0.5) newScale = 0.5;
          if (newScale > 5.0) newScale = 5.0;
          scale = newScale;

          // 2. Pan (–ü–µ—Ä–µ–º–µ—â–µ–Ω–∏–µ)
          const mid = getMidpoint(e.touches);
          pointX = mid.x - startX; 
          pointY = mid.y - startY;

          updateTransform();
          return;
      }

      // –õ–æ–≥–∏–∫–∞ –†–∏—Å–æ–≤–∞–Ω–∏—è (–µ—Å–ª–∏ –Ω–µ –∂–µ—Å—Ç)
      if (window.drawing && !isGesture) {
          const p = getPaintPosition(e);
          
          const lineWidth = sizeEl.value;
          
          if (window.mode === "draw") {
              ctx.globalCompositeOperation = "source-over";
              ctx.strokeStyle = getColor();
              ctx.lineWidth = lineWidth;
          } else if (window.mode === "erase") {
              ctx.globalCompositeOperation = "destination-out";
              ctx.lineWidth = lineWidth;
          }
          
          // –ò–Ω—Ç–µ—Ä–ø–æ–ª—è—Ü–∏—è –¥–ª—è –ø–ª–∞–≤–Ω–æ—Å—Ç–∏ (–æ—Å–æ–±–µ–Ω–Ω–æ –ø—Ä–∏ –∑—É–º–µ)
          ctx.lineCap = "round";
          ctx.lineJoin = "round";
          ctx.beginPath();
          ctx.moveTo(lastX, lastY);
          ctx.lineTo(p.x, p.y);
          ctx.stroke();
          
          lastX = p.x;
          lastY = p.y;
      }
  }

  function onPointerUp(e) {
      window.drawing = false;
      if (e.touches && e.touches.length < 2) {
          isGesture = false;
      }
  }

  window.clearCanvas = () => {
    ctx.clearRect(0,0,canvas.width,canvas.height);
    ctx.globalCompositeOperation = "source-over";
    ctx.fillStyle = "#fff";
    ctx.fillRect(0,0,canvas.width,canvas.height);
  }
  
  // --- FIREBASE (–ë–µ–∑ –∏–∑–º–µ–Ω–µ–Ω–∏–π –ª–æ–≥–∏–∫–∏) ---
  window.saveToFirebase = async () => {
    if(!confirm("–û–ø—É–±–ª–∏–∫–æ–≤–∞—Ç—å?")) return;
    loader.style.display = "inline"; 
    try {
        const imgData = canvas.toDataURL("image/png");
        await addDoc(galleryRef, {
            image: imgData,
            date: Date.now(),
            deleteVotes: 0,       
            voters: []            
        });
        alert("–û–ø—É–±–ª–∏–∫–æ–≤–∞–Ω–æ!");
        window.toggleGallery(); 
    } catch (e) {
        console.error(e);
        alert("–û—à–∏–±–∫–∞: " + e.message);
    } finally {
        loader.style.display = "none";
    }
  };

  window.voteToDelete = async (docId, currentVotes, currentVoters) => {
      if (!confirm("–ü–æ–∂–∞–ª–æ–≤–∞—Ç—å—Å—è (18+)?")) return;
      if (currentVoters.includes(USER_ID)) { alert("–í—ã —É–∂–µ –≥–æ–ª–æ—Å–æ–≤–∞–ª–∏."); return; }
      
      const docRef = doc(db, "drawings", docId);
      try {
          const newVotes = currentVotes + 1;
          if (newVotes >= 10) {
              await deleteDoc(docRef);
              alert("–£–¥–∞–ª–µ–Ω–æ.");
              loadGlobalGallery();
          } else {
              await updateDoc(docRef, { deleteVotes: increment(1), voters: arrayUnion(USER_ID) });
              alert(`–ì–æ–ª–æ—Å –ø—Ä–∏–Ω—è—Ç. ${newVotes}/10`);
              document.getElementById(`votes-${docId}`).textContent = `üö® ${newVotes}/10`;
          }
      } catch (e) { console.error(e); }
  };

  async function loadGlobalGallery() {
    const content = document.getElementById("galleryContent");
    content.innerHTML = "<p style='color:#0f0'>–ó–∞–≥—Ä—É–∑–∫–∞...</p>";
    try {
        const q = query(galleryRef, orderBy("date", "desc"), limit(20));
        const querySnapshot = await getDocs(q);
        content.innerHTML = ""; 
        if(querySnapshot.empty) { content.innerHTML = "<p>–ü—É—Å—Ç–æ.</p>"; return; }

        querySnapshot.forEach((docSnap) => {
            const data = docSnap.data();
            const div = document.createElement("div");
            div.className = "gallery-item";
            
            const img = new Image();
            img.src = data.image;
            img.onclick = () => {
                if(confirm("–†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å —ç—Ç–æ—Ç —Ä–∏—Å—É–Ω–æ–∫?")) {
                    const pic = new Image();
                    pic.src = data.image;
                    pic.onload = () => {
                        window.clearCanvas(); 
                        ctx.drawImage(pic, 0,0);
                        centerCanvas();
                    }
                    window.toggleGallery();
                }
            };
            
            const btn = document.createElement("button");
            btn.classList.add('danger-btn');
            btn.textContent = "Report";
            btn.style.fontSize = "10px";
            btn.style.marginTop = "5px";
            btn.onclick = () => window.voteToDelete(docSnap.id, data.deleteVotes || 0, data.voters || []);
            
            const info = document.createElement("div");
            info.innerHTML = `<span id="votes-${docSnap.id}" style="col
