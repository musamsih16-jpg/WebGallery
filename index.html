<!DOCTYPE html>
<html lang="ru">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
<title>Suno Global Canvas Pro</title>
<style>
:root {
  --bg-color: #121212; --panel-bg: #222222; --btn-bg: #333333; --text-color: #f0f0f0; --accent: #008cff;
}
body {
  margin: 0; padding: 0; background: var(--bg-color); color: var(--text-color);
  font-family: sans-serif; height: 100vh; display: flex; flex-direction: column; overflow: hidden;
}
#top-bar {
  background: var(--panel-bg); padding: 8px; display: flex; gap: 8px; align-items: center;
  border-bottom: 1px solid #444; overflow-x: auto; white-space: nowrap; flex-shrink: 0; z-index: 9999;
}
.size-inputs { display: flex; align-items: center; gap: 5px; }
.size-inputs input { width: 45px; background: #000; color: #fff; border: 1px solid #555; border-radius: 4px; padding: 5px; }
button { background: var(--btn-bg); color: #fff; border: 1px solid #555; border-radius: 5px; padding: 8px 12px; font-size: 14px; cursor: pointer; }
#viewport { flex-grow: 1; position: relative; background: #181818; overflow: hidden; touch-action: none; }
canvas { position: absolute; background: #fff; transform-origin: 0 0; box-shadow: 0 0 20px rgba(0,0,0,0.5); }
.floating-panel {
  position: fixed; top: 70px; background: rgba(30,30,30,0.95); border: 1px solid #666;
  border-radius: 8px; padding: 15px; display: none; flex-direction: column; gap: 10px; z-index: 10000; width: 220px;
}
.preview-container { 
    display: flex; flex-direction: column; gap: 8px; margin-bottom: 10px; 
    background: #000; padding: 10px; border-radius: 6px; border: 1px solid #444;
}
#color-preview { width: 100%; height: 25px; border: 1px solid #fff; border-radius: 3px; }
#size-preview-box { 
    width: 100%; height: 80px; background: #111; border-radius: 4px; 
    display: flex; align-items: center; justify-content: center; overflow: hidden;
}
#size-indicator { background: #fff; border-radius: 50%; }
.label-row { display: flex; justify-content: space-between; font-size: 13px; color: #eee; margin-top: 5px; font-weight: bold; }
input[type=range] { width: 100%; height: 25px; cursor: pointer; }
#gallery-overlay { position: fixed; inset: 0; background: #000; z-index: 20000; display: none; flex-direction: column; padding: 15px; }
#gallery-content { margin-top: 15px; display: grid; grid-template-columns: repeat(auto-fill, minmax(130px, 1fr)); gap: 10px; overflow-y: auto; }
.art-card { background: #222; padding: 5px; border-radius: 6px; text-align: center; }
.art-card img { width: 100%; height: 120px; object-fit: contain; }
</style>
</head>
<body>

<div id="top-bar">
  <button onclick="undo()">‚Ü©Ô∏è</button>
  <button onclick="redo()">‚Ü™Ô∏è</button>
  <button onclick="toggle('tools-panel')">üõ†</button>
  <div class="size-inputs">
    <input type="number" id="inpW" value="360" onchange="resizeCanvas()">
    <input type="number" id="inpH" value="500" onchange="resizeCanvas()">
  </div>
  <button onclick="toggle('colors-panel')">üé®</button>
  <button onclick="toggle('lang-panel')">üåê</button>
  <button onclick="toggleGallery()" id="btn-global">üåç –ì–ª–æ–±–∞–ª—å–Ω–æ</button>
  <button onclick="saveToCloud()" style="color:var(--accent)" id="btn-save">‚òÅÔ∏è –ó–∞–ø—É—Å—Ç–∏—Ç—å</button>
  <button id="btn-download" onclick="downloadImg()">üíæ</button>
  <button onclick="resetView()">üéØ</button>
  <button onclick="clearCanvas()" style="color:red">üóë</button>
</div>

<div id="lang-panel" class="floating-panel" style="left:50%; transform: translateX(-50%);"></div>

<div id="tools-panel" class="floating-panel" style="left:10px">
  <button onclick="setMode('draw')" id="m-brush">‚úèÔ∏è –ö–∏—Å—Ç—å</button>
  <button onclick="setMode('erase')" id="m-erase">üßΩ –õ–∞—Å—Ç–∏–∫</button>
  <button onclick="setMode('fill')" id="m-fill">‚¨õ –ó–∞–ª–∏–≤–∫–∞</button>
</div>

<div id="colors-panel" class="floating-panel" style="right:10px">
  <div class="preview-container">
    <div id="color-preview"></div>
    <div id="size-preview-box"><div id="size-indicator"></div></div>
  </div>
  <div class="label-row"><span id="lbl-size">–†–∞–∑–º–µ—Ä</span><span id="val-size">5</span></div>
  <input type="range" id="size" min="1" max="100" value="5" oninput="updColor()">
  
  <div class="label-row"><span>R</span><span id="val-r">0</span></div>
  <input type="range" id="r" max="255" value="0" oninput="updColor()">
  
  <div class="label-row"><span>G</span><span id="val-g">0</span></div>
  <input type="range" id="g" max="255" value="0" oninput="updColor()">
  
  <div class="label-row"><span>B</span><span id="val-b">0</span></div>
  <input type="range" id="b" max="255" value="0" oninput="updColor()">
</div>

<div id="viewport"><canvas id="canvas" width="360" height="500"></canvas></div>

<div id="gallery-overlay">
  <button onclick="toggleGallery()" id="btn-close-gallery">‚ùå –ó–∞–∫—Ä—ã—Ç—å</button>
  <div id="gallery-content"></div>
</div>

<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
import { getFirestore, collection, addDoc, getDocs, query, orderBy, limit } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

const firebaseConfig = {
    apiKey: "AIzaSyCekB6vZ6qGAnvDO1LOA7OUGmA3zU1aLoA",
    authDomain: "suno-gallery.firebaseapp.com",
    projectId: "suno-gallery",
    appId: "1:314284584278:web:97c5b91180562fd1c93af7"
};

const app = initializeApp(firebaseConfig);
const db = getFirestore(app);
const galleryRef = collection(db, "drawings");

window.saveToCloud = async () => {
    if(!confirm(window.t('confirm'))) return;
    try {
        await addDoc(galleryRef, { image: canvas.toDataURL('image/jpeg', 0.5), date: Date.now() });
        alert(window.t('success'));
    } catch(e) { alert("Error: " + e.message); }
};

window.loadGlobalGallery = async () => {
    const box = document.getElementById("gallery-content");
    box.innerHTML = window.t('loading');
    const snap = await getDocs(query(galleryRef, orderBy("date", "desc"), limit(20)));
    box.innerHTML = "";
    snap.forEach(d => {
        const data = d.data();
        const div = document.createElement("div");
        div.className = "art-card";
        div.innerHTML = `<img src="${data.image}"><button>${window.t('report')}</button>`;
        box.appendChild(div);
    });
};
</script>

<script>
const translations = {
    "az": { name: "Az…ôrbaycan", global: "üåç Qlobal", save: "‚òÅÔ∏è Yayƒ±mla", brush: "‚úèÔ∏è Fƒ±r√ßa", erase: "üßΩ Pozan", fill: "‚¨õ Doldurma", close: "‚ùå Baƒüla", confirm: "D…ôrc edilsin?", success: "D…ôrc edildi!", loading: "Y√ºkl…ônir...", report: "≈ûikay…ôt", size: "√ñl√ß√º" },
    "ru": { name: "–†—É—Å—Å–∫–∏–π", global: "üåç –ì–ª–æ–±–∞–ª—å–Ω–æ", save: "‚òÅÔ∏è –ó–∞–ø—É—Å—Ç–∏—Ç—å", brush: "‚úèÔ∏è –ö–∏—Å—Ç—å", erase: "üßΩ –õ–∞—Å—Ç–∏–∫", fill: "‚¨õ –ó–∞–ª–∏–≤–∫–∞", close: "‚ùå –ó–∞–∫—Ä—ã—Ç—å", confirm: "–û–ø—É–±–ª–∏–∫–æ–≤–∞—Ç—å?", success: "–û–ø—É–±–ª–∏–∫–æ–≤–∞–Ω–æ!", loading: "–ó–∞–≥—Ä—É–∑–∫–∞...", report: "–ñ–∞–ª–æ–±–∞", size: "–†–∞–∑–º–µ—Ä" },
    "en": { name: "English", global: "üåç Global", save: "‚òÅÔ∏è Launch", brush: "‚úèÔ∏è Brush", erase: "üßΩ Eraser", fill: "‚¨õ Fill", close: "‚ùå Close", confirm: "Publish?", success: "Published!", loading: "Loading...", report: "Report", size: "Size" }
};

let currentLang = 'ru';
window.t = (key) => translations[currentLang][key] || key;

function applyLang() {
    document.getElementById('btn-global').innerText = window.t('global');
    document.getElementById('btn-save').innerText = window.t('save');
    document.getElementById('m-brush').innerText = window.t('brush');
    document.getElementById('m-erase').innerText = window.t('erase');
    document.getElementById('m-fill').innerText = window.t('fill');
    document.getElementById('lbl-size').innerText = window.t('size');
}

function initLang() {
    const panel = document.getElementById('lang-panel');
    Object.keys(translations).forEach(lang => {
        const btn = document.createElement('button');
        btn.innerText = translations[lang].name;
        btn.style.width = "100%";
        btn.onclick = () => { currentLang = lang; applyLang(); toggle('lang-panel'); };
        panel.appendChild(btn);
    });
}

const canvas = document.getElementById("canvas");
const ctx = canvas.getContext("2d");
const viewport = document.getElementById("viewport");
const preview = document.getElementById("color-preview");
const sizeInd = document.getElementById("size-indicator");

let scale = 1, pX = 0, pY = 0, mode = "draw", isDrawing = false, lastX = 0, lastY = 0;
let history = []; let historyStep = -1;

function updColor() {
    const r = document.getElementById('r').value, g = document.getElementById('g').value, b = document.getElementById('b').value, s = document.getElementById('size').value;
    const color = `rgb(${r},${g},${b})`;
    preview.style.background = color;
    sizeInd.style.background = color;
    sizeInd.style.width = s + "px"; sizeInd.style.height = s + "px";
    document.getElementById('val-r').innerText = r;
    document.getElementById('val-g').innerText = g;
    document.getElementById('val-b').innerText = b;
    document.getElementById('val-size').innerText = s;
}

function saveHistory() {
    historyStep++;
    if (historyStep < history.length) history.length = historyStep;
    history.push(canvas.toDataURL());
    if (history.length > 20) { history.shift(); historyStep--; }
}

function undo() {
    if (historyStep > 0) {
        historyStep--;
        let img = new Image();
        img.onload = () => { ctx.fillStyle = "#fff"; ctx.fillRect(0,0,canvas.width,canvas.height); ctx.drawImage(img, 0, 0); };
        img.src = history[historyStep];
    }
}

function redo() {
    if (historyStep < history.length - 1) {
        historyStep++;
        let img = new Image();
        img.onload = () => { ctx.fillStyle = "#fff"; ctx.fillRect(0,0,canvas.width,canvas.height); ctx.drawImage(img, 0, 0); };
        img.src = history[historyStep];
    }
}

function downloadImg() {
    const btn = document.getElementById('btn-download');
    const oldText = btn.innerText;
    btn.innerText = "‚åõ";

    try {
        const dataUrl = canvas.toDataURL('image/jpeg', 0.9);
        const byteString = atob(dataUrl.split(',')[1]);
        const ab = new ArrayBuffer(byteString.length);
        const ia = new Uint8Array(ab);
        for (let i = 0; i < byteString.length; i++) ia[i] = byteString.charCodeAt(i);
        const blob = new Blob([ab], {type: 'image/jpeg'});
        
        const blobUrl = URL.createObjectURL(blob);
        const link = document.createElement('a');
        link.href = blobUrl;
        link.download = `art_${Date.now()}.jpg`;
        document.body.appendChild(link);
        link.click();
        
        setTimeout(() => {
            document.body.removeChild(link);
            window.URL.revokeObjectURL(blobUrl);
            btn.innerText = oldText;
        }, 200);
    } catch (e) {
        alert("–û—à–∏–±–∫–∞: " + e.message);
        btn.innerText = oldText;
    }
}

function getPos(e) {
    const rect = viewport.getBoundingClientRect();
    const t = e.touches ? e.touches[0] : e;
    return { x: (t.clientX - rect.left - pX) / scale, y: (t.clientY - rect.top - pY) / scale };
}

viewport.addEventListener('touchstart', e => {
    if(e.touches.length === 1) {
        isDrawing = true;
        const p = getPos(e); lastX = p.x; lastY = p.y;
        if(mode === 'fill') { ctx.fillStyle = preview.style.background; ctx.fillRect(0,0,canvas.width,canvas.height); saveHistory(); }
    }
}, {passive: false});

viewport.addEventListener('touchmove', e => {
    if(isDrawing && e.touches.length === 1) {
        const p = getPos(e);
        ctx.beginPath(); ctx.lineCap = "round"; 
        ctx.lineWidth = document.getElementById('size').value;
        ctx.strokeStyle = (mode === 'erase') ? '#ffffff' : preview.style.background;
        ctx.moveTo(lastX, lastY); ctx.lineTo(p.x, p.y); ctx.stroke();
        lastX = p.x; lastY = p.y;
    }
}, {passive: false});

window.addEventListener('touchend', () => { if(isDrawing) saveHistory(); isDrawing = false; });

function toggle(id) {
    const el = document.getElementById(id);
    const vis = el.style.display === 'flex';
    document.querySelectorAll('.floating-panel').forEach(p => p.style.display = 'none');
    el.style.display = vis ? 'none' : 'flex';
}

function toggleGallery() {
    const g = document.getElementById('gallery-overlay');
    g.style.display = g.style.display === 'flex' ? 'none' : 'flex';
    if(g.style.display === 'flex') window.loadGlobalGallery();
}

function setMode(m) { mode = m; toggle('tools-panel'); }
function clearCanvas() { if(confirm("Clear?")) { ctx.fillStyle="#fff"; ctx.fillRect(0,0,canvas.width,canvas.height); saveHistory(); } }
function resizeCanvas() { 
    canvas.width = document.getElementById('inpW').value; 
    canvas.height = document.getElementById('inpH').value; 
    ctx.fillStyle="#fff"; ctx.fillRect(0,0,canvas.width,canvas.height); resetView();
}
function resetView() { scale = 0.8; pX = 20; pY = 20; updateTransform(); }
function updateTransform() { canvas.style.transform = `translate(${pX}px, ${pY}px) scale(${scale})`; }

ctx.fillStyle = "#fff"; ctx.fillRect(0,0,360,500);
initLang(); applyLang(); updColor(); saveHistory(); resetView();
</script>
</body>
</html>
