<!DOCTYPE html>
<html lang="ru">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
<title>Suno Global Canvas Pro</title>
<style>
:root {
  --bg-color: #121212; --panel-bg: #222222; --btn-bg: #333333; --text-color: #f0f0f0; --accent: #008cff;
}
body {
  margin: 0; padding: 0; background: var(--bg-color); color: var(--text-color);
  font-family: sans-serif; height: 100vh; display: flex; flex-direction: column; overflow: hidden;
}
#top-bar {
  background: var(--panel-bg); padding: 8px; display: flex; gap: 8px; align-items: center;
  border-bottom: 1px solid #444; overflow-x: auto; white-space: nowrap; flex-shrink: 0; z-index: 9999;
}
.size-inputs { display: flex; align-items: center; gap: 5px; }
.size-inputs input { width: 45px; background: #000; color: #fff; border: 1px solid #555; border-radius: 4px; padding: 5px; }
button { background: var(--btn-bg); color: #fff; border: 1px solid #555; border-radius: 5px; padding: 8px 12px; font-size: 14px; cursor: pointer; }
button:disabled { opacity: 0.3; }
#viewport { flex-grow: 1; position: relative; background: #181818; overflow: hidden; touch-action: none; }
canvas { position: absolute; background: #fff; transform-origin: 0 0; }
.floating-panel {
  position: fixed; top: 70px; background: rgba(30,30,30,0.95); border: 1px solid #666;
  border-radius: 8px; padding: 15px; display: none; flex-direction: column; gap: 10px; z-index: 10000;
  max-height: 80vh; overflow-y: auto; width: 220px;
}
.preview-container { display: flex; flex-direction: column; gap: 5px; margin-bottom: 5px; }
#color-preview { width: 100%; height: 30px; border: 2px solid #fff; border-radius: 4px; background: #000; }
#size-preview-box { 
    width: 100%; height: 60px; background: #000; border-radius: 4px; border: 1px solid #555;
    display: flex; align-items: center; justify-content: center; overflow: hidden;
}
#size-indicator { background: #fff; border-radius: 50%; transition: 0.1s; }
.label-row { display: flex; justify-content: space-between; font-size: 12px; color: #aaa; margin-top: 5px; }
input[type=range] { width: 100%; height: 20px; cursor: pointer; }
#gallery-overlay { position: fixed; inset: 0; background: #000; z-index: 20000; display: none; flex-direction: column; padding: 15px; }
#gallery-content { margin-top: 15px; display: grid; grid-template-columns: repeat(auto-fill, minmax(130px, 1fr)); gap: 10px; overflow-y: auto; }
.art-card { background: #222; padding: 5px; border-radius: 6px; text-align: center; }
.art-card img { width: 100%; height: 120px; object-fit: contain; }
</style>
</head>
<body>

<div id="top-bar">
  <button onclick="undo()">‚Ü©Ô∏è</button>
  <button onclick="redo()">‚Ü™Ô∏è</button>
  <button onclick="toggle('tools-panel')">üõ†</button>
  <div class="size-inputs">
    <input type="number" id="inpW" value="360" onchange="resizeCanvas()">
    <input type="number" id="inpH" value="500" onchange="resizeCanvas()">
  </div>
  <button onclick="toggle('colors-panel')">üé®</button>
  <button onclick="toggle('lang-panel')">üåê</button>
  <button onclick="toggleGallery()" id="btn-global">üåç –ì–ª–æ–±–∞–ª—å–Ω–æ</button>
  <button onclick="saveToCloud()" style="color:var(--accent)" id="btn-save">‚òÅÔ∏è –ó–∞–ø—É—Å—Ç–∏—Ç—å</button>
  <button onclick="downloadImg()">üíæ</button>
  <button onclick="resetView()">üéØ</button>
  <button onclick="clearCanvas()" style="color:red">üóë</button>
</div>

<div id="lang-panel" class="floating-panel" style="left:50%; transform: translateX(-50%);"></div>

<div id="tools-panel" class="floating-panel" style="left:10px">
  <button onclick="setMode('draw')" id="m-brush">‚úèÔ∏è –ö–∏—Å—Ç—å</button>
  <button onclick="setMode('erase')" id="m-erase">üßΩ –õ–∞—Å—Ç–∏–∫</button>
  <button onclick="setMode('fill')" id="m-fill">‚¨õ –ó–∞–ª–∏–≤–∫–∞</button>
  <button onclick="document.getElementById('fileIn').click()" id="m-photo">üìÅ –§–æ—Ç–æ</button>
  <input type="file" id="fileIn" hidden accept="image/*" onchange="handleImage(event)">
</div>

<div id="colors-panel" class="floating-panel" style="right:10px">
  <div class="preview-container">
    <div id="color-preview"></div>
    <div id="size-preview-box">
        <div id="size-indicator"></div>
    </div>
  </div>
  
  <div class="label-row"><span id="lbl-size">–†–∞–∑–º–µ—Ä</span><span id="val-size">5</span></div>
  <input type="range" id="size" min="1" max="100" value="5" oninput="updColor()">
  
  <div class="label-row"><span>R</span><span id="val-r">0</span></div>
  <input type="range" id="r" max="255" value="0" oninput="updColor()">
  
  <div class="label-row"><span>G</span><span id="val-g">0</span></div>
  <input type="range" id="g" max="255" value="0" oninput="updColor()">
  
  <div class="label-row"><span>B</span><span id="val-b">0</span></div>
  <input type="range" id="b" max="255" value="0" oninput="updColor()">
</div>

<div id="viewport">
  <canvas id="canvas" width="360" height="500"></canvas>
</div>

<div id="gallery-overlay">
  <button onclick="toggleGallery()" id="btn-close-gallery">‚ùå –ó–∞–∫—Ä—ã—Ç—å</button>
  <div id="gallery-content"></div>
</div>

<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
import { getFirestore, collection, addDoc, getDocs, query, orderBy, limit, doc, updateDoc, increment, arrayUnion } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

const firebaseConfig = {
    apiKey: "AIzaSyCekB6vZ6qGAnvDO1LOA7OUGmA3zU1aLoA",
    authDomain: "suno-gallery.firebaseapp.com",
    projectId: "suno-gallery",
    appId: "1:314284584278:web:97c5b91180562fd1c93af7"
};

const app = initializeApp(firebaseConfig);
const db = getFirestore(app);
const galleryRef = collection(db, "drawings");
let USER_ID = localStorage.getItem("u_id") || ('u'+Math.random());
localStorage.setItem("u_id", USER_ID);

let localReported = new Set(); 

window.saveToCloud = async () => {
    if(!confirm(window.t('confirm'))) return;
    try {
        await addDoc(galleryRef, { image: canvas.toDataURL('image/jpeg', 0.6), date: Date.now(), reports: 0, reporters: [] });
        alert(window.t('success'));
    } catch(e) { alert("Error"); }
};

window.loadGlobalGallery = async () => {
    const box = document.getElementById("gallery-content");
    box.innerHTML = window.t('loading');
    const snap = await getDocs(query(galleryRef, orderBy("date", "desc"), limit(20)));
    box.innerHTML = "";
    snap.forEach(d => {
        const data = d.data();
        const isReported = localReported.has(d.id) || (data.reporters && data.reporters.includes(USER_ID));
        const div = document.createElement("div");
        div.className = "art-card";
        div.innerHTML = `<img src="${data.image}"><button ${isReported?'disabled':''} class="report-btn">${isReported ? window.t('reported') : window.t('report')} (${data.reports||0})</button>`;
        div.querySelector("button").onclick = async (e) => {
            if(!confirm(window.t('confirm_report'))) return;
            await updateDoc(doc(db, "drawings", d.id), { reports: increment(1), reporters: arrayUnion(USER_ID) });
            localReported.add(d.id);
            e.target.disabled = true;
            e.target.innerText = window.t('reported');
        };
        box.appendChild(div);
    });
};
</script>

<script>
const translations = {
    "az": { name: "Az…ôrbaycan", global: "üåç Qlobal", save: "‚òÅÔ∏è Yayƒ±mla", brush: "‚úèÔ∏è Fƒ±r√ßa", erase: "üßΩ Pozan", fill: "‚¨õ Doldurma", photo: "üìÅ ≈û…ôkil", close: "‚ùå Baƒüla", confirm: "D…ôrc edilsin?", success: "D…ôrc edildi!", loading: "Y√ºkl…ônir...", report: "≈ûikay…ôt", reported: "≈ûikay…ôt edildi", confirm_report: "≈ûikay…ôt edilsin?", size: "√ñl√ß√º" },
    "de": { name: "Deutsch", global: "üåç Global", save: "‚òÅÔ∏è Starten", brush: "‚úèÔ∏è Pinsel", erase: "üßΩ Radierer", fill: "‚¨õ F√ºllen", photo: "üìÅ Foto", close: "‚ùå Schlie√üen", confirm: "Ver√∂ffentlichen?", success: "Ver√∂ffentlicht!", loading: "Laden...", report: "Melden", reported: "Gemeldet", confirm_report: "Meldung best√§tigen?", size: "Gr√∂√üe" },
    "en": { name: "English", global: "üåç Global", save: "‚òÅÔ∏è Launch", brush: "‚úèÔ∏è Brush", erase: "üßΩ Eraser", fill: "‚¨õ Fill", photo: "üìÅ Photo", close: "‚ùå Close", confirm: "Publish?", success: "Published!", loading: "Loading...", report: "Report", reported: "Reported", confirm_report: "Confirm report?", size: "Size" },
    "es": { name: "Espa√±ol", global: "üåç Global", save: "‚òÅÔ∏è Lanzar", brush: "‚úèÔ∏è Pincel", erase: "üßΩ Borrador", fill: "‚¨õ Rellenar", photo: "üìÅ Foto", close: "‚ùå Cerrar", confirm: "¬øPublicar?", success: "¬°Publicado!", loading: "Cargando...", report: "Reportar", reported: "Reportado", confirm_report: "¬øConfirmar reporte?", size: "Tama√±o" },
    "fr": { name: "Fran√ßais", global: "üåç Global", save: "‚òÅÔ∏è Publier", brush: "‚úèÔ∏è Pinceau", erase: "üßΩ Gomme", fill: "‚¨õ Remplir", photo: "üìÅ Photo", close: "‚ùå Fermer", confirm: "Publier?", success: "Publi√©!", loading: "Chargement...", report: "Signaler", reported: "Signal√©", confirm_report: "Confirmer le signalement?", size: "Taille" },
    "it": { name: "Italiano", global: "üåç Globale", save: "‚òÅÔ∏è Avvia", brush: "‚úèÔ∏è Pennello", erase: "üßΩ Gomma", fill: "‚¨õ Riempi", photo: "üìÅ Foto", close: "‚ùå Chiudi", confirm: "Pubblicare?", success: "Pubblicato!", loading: "Caricamento...", report: "Segnala", reported: "Segnalato", confirm_report: "Confermi la segnalazione?", size: "Dimensione" },
    "jp": { name: "Êó•Êú¨Ë™û", global: "üåç „Ç∞„É≠„Éº„Éê„É´", save: "‚òÅÔ∏è ÂÖ¨Èñã„Åô„Çã", brush: "‚úèÔ∏è „Éñ„É©„Ç∑", erase: "üßΩ Ê∂à„Åó„Ç¥„É†", fill: "‚¨õ Â°ó„Çä„Å§„Å∂„Åó", photo: "üìÅ ÂÜôÁúü", close: "‚ùå Èñâ„Åò„Çã", confirm: "ÂÖ¨Èñã„Åó„Åæ„Åô„ÅãÔºü", success: "ÂÖ¨Èñã„Åï„Çå„Åæ„Åó„ÅüÔºÅ", loading: "Ë™≠„ÅøËæº„Åø‰∏≠...", report: "ÈÄöÂ†±", reported: "ÈÄöÂ†±Ê∏à„Åø", confirm_report: "ÈÄöÂ†±„Åó„Åæ„Åô„ÅãÔºü", size: "„Çµ„Ç§„Ç∫" },
    "ko": { name: "ÌïúÍµ≠Ïñ¥", global: "üåç Í∏ÄÎ°úÎ≤å", save: "‚òÅÔ∏è Í≤åÏãúÌïòÍ∏∞", brush: "‚úèÔ∏è Î∏åÎü¨Ïãú", erase: "üßΩ ÏßÄÏö∞Í∞ú", fill: "‚¨õ Ï±ÑÏö∞Í∏∞", photo: "üìÅ ÏÇ¨ÏßÑ", close: "‚ùå Îã´Í∏∞", confirm: "Í≤åÏãúÌïòÏãúÍ≤†ÏäµÎãàÍπå?", success: "Í≤åÏãúÎêòÏóàÏäµÎãàÎã§!", loading: "Î°úÎî© Ï§ë...", report: "Ïã†Í≥†", reported: "Ïã†Í≥†Îê®", confirm_report: "Ïã†Í≥†ÌïòÏãúÍ≤†ÏäµÎãàÍπå?", size: "ÌÅ¨Í∏∞" },
    "pt": { name: "Portugu√™s", global: "üåç Global", save: "‚òÅÔ∏è Iniciar", brush: "‚úèÔ∏è Pincel", erase: "üßΩ Borracha", fill: "‚¨õ Preencher", photo: "üìÅ Foto", close: "‚ùå Fechar", confirm: "Publicar?", success: "Publicado!", loading: "Carregando...", report: "Denunciar", reported: "Denunciado", confirm_report: "Confirmar den√∫ncia?", size: "Tamanho" },
    "ru": { name: "–†—É—Å—Å–∫–∏–π", global: "üåç –ì–ª–æ–±–∞–ª—å–Ω–æ", save: "‚òÅÔ∏è –ó–∞–ø—É—Å—Ç–∏—Ç—å", brush: "‚úèÔ∏è –ö–∏—Å—Ç—å", erase: "üßΩ –õ–∞—Å—Ç–∏–∫", fill: "‚¨õ –ó–∞–ª–∏–≤–∫–∞", photo: "üìÅ –§–æ—Ç–æ", close: "‚ùå –ó–∞–∫—Ä—ã—Ç—å", confirm: "–û–ø—É–±–ª–∏–∫–æ–≤–∞—Ç—å?", success: "–û–ø—É–±–ª–∏–∫–æ–≤–∞–Ω–æ!", loading: "–ó–∞–≥—Ä—É–∑–∫–∞...", report: "–ñ–∞–ª–æ–±–∞", reported: "–û—Ç–ø—Ä–∞–≤–ª–µ–Ω–æ", confirm_report: "–ü–æ–∂–∞–ª–æ–≤–∞—Ç—å—Å—è?", size: "–†–∞–∑–º–µ—Ä" },
    "tr": { name: "T√ºrk√ße", global: "üåç K√ºresel", save: "‚òÅÔ∏è Ba≈ülat", brush: "‚úèÔ∏è Fƒ±r√ßa", erase: "üßΩ Silgi", fill: "‚¨õ Doldur", photo: "üìÅ Fotoƒüraf", close: "‚ùå Kapat", confirm: "Yayƒ±nlansƒ±n mƒ±?", success: "Yayƒ±nlandƒ±!", loading: "Y√ºkleniyor...", report: "Bildir", reported: "Bildirildi", confirm_report: "Bildirmeyi onayla?", size: "Boyut" },
    "zh": { name: "‰∏≠Êñá", global: "üåç ÂÖ®ÁêÉ", save: "‚òÅÔ∏è ÂèëÂ∏É", brush: "‚úèÔ∏è ÁîªÁ¨î", erase: "üßΩ Ê©°ÁöÆÊì¶", fill: "‚¨õ Â°´ÂÖÖ", photo: "üìÅ ÁÖßÁâá", close: "‚ùå ÂÖ≥Èó≠", confirm: "Á°ÆÂÆöÂèëÂ∏ÉÂêóÔºü", success: "Â∑≤ÂèëÂ∏ÉÔºÅ", loading: "Âä†ËΩΩ‰∏≠...", report: "‰∏æÊä•", reported: "Â∑≤‰∏æÊä•", confirm_report: "Á°ÆÂÆö‰∏æÊä•ÂêóÔºü", size: "Â§ßÂ∞è" }
};

let currentLang = localStorage.getItem('lang') || 'ru';
window.t = (key) => translations[currentLang][key] || key;

function applyLang() {
    document.getElementById('btn-global').innerText = window.t('global');
    document.getElementById('btn-save').innerText = window.t('save');
    document.getElementById('m-brush').innerText = window.t('brush');
    document.getElementById('m-erase').innerText = window.t('erase');
    document.getElementById('m-fill').innerText = window.t('fill');
    document.getElementById('m-photo').innerText = window.t('photo');
    document.getElementById('btn-close-gallery').innerText = window.t('close');
    document.getElementById('lbl-size').innerText = window.t('size');
}

function initLangMenu() {
    const panel = document.getElementById('lang-panel');
    const sortedKeys = Object.keys(translations).sort((a, b) => translations[a].name.localeCompare(translations[b].name));
    sortedKeys.forEach(lang => {
        const btn = document.createElement('button');
        btn.innerText = translations[lang].name;
        btn.style.width = "100%";
        btn.onclick = () => {
            currentLang = lang;
            localStorage.setItem('lang', lang);
            applyLang();
            toggle('lang-panel');
        };
        panel.appendChild(btn);
    });
}

const canvas = document.getElementById("canvas");
const ctx = canvas.getContext("2d");
const viewport = document.getElementById("viewport");
const preview = document.getElementById("color-preview");
const sizeInd = document.getElementById("size-indicator");

let scale = 1, pX = 0, pY = 0, mode = "draw", isDrawing = false, lastX = 0, lastY = 0;
let history = [];
let historyStep = -1;

function updColor() {
    const r = document.getElementById('r').value;
    const g = document.getElementById('g').value;
    const b = document.getElementById('b').value;
    const s = document.getElementById('size').value;
    
    const color = `rgb(${r},${g},${b})`;
    preview.style.background = color;
    sizeInd.style.background = color;
    sizeInd.style.width = s + "px";
    sizeInd.style.height = s + "px";
    
    document.getElementById('val-r').innerText = r;
    document.getElementById('val-g').innerText = g;
    document.getElementById('val-b').innerText = b;
    document.getElementById('val-size').innerText = s;
}

function saveHistory() {
    historyStep++;
    if (historyStep < history.length) history.length = historyStep;
    history.push(canvas.toDataURL());
    if (history.length > 20) { history.shift(); historyStep--; }
}

function undo() {
    if (historyStep > 0) {
        historyStep--;
        let img = new Image();
        img.onload = () => { ctx.fillStyle = "#fff"; ctx.fillRect(0,0,canvas.width,canvas.height); ctx.drawImage(img, 0, 0); };
        img.src = history[historyStep];
    }
}

function redo() {
    if (historyStep < history.length - 1) {
        historyStep++;
        let img = new Image();
        img.onload = () => { ctx.fillStyle = "#fff"; ctx.fillRect(0,0,canvas.width,canvas.height); ctx.drawImage(img, 0, 0); };
        img.src = history[historyStep];
    }
}

function toggle(id) {
    const el = document.getElementById(id);
    const isVisible = el.style.display === 'flex';
    document.querySelectorAll('.floating-panel').forEach(p => p.style.display = 'none');
    el.style.display = isVisible ? 'none' : 'flex';
}

function toggleGallery() {
    const gal = document.getElementById("gallery-overlay");
    gal.style.display = (gal.style.display === 'flex') ? 'none' : 'flex';
    if(gal.style.display === 'flex') window.loadGlobalGallery();
}

function setMode(m) { mode = m; toggle('tools-panel'); }

function clearCanvas() { 
    if(!confirm("Reset?")) return;
    ctx.fillStyle = "#ffffff"; ctx.fillRect(0,0,canvas.width,canvas.height); 
    saveHistory();
}

function resizeCanvas() {
    const w = document.getElementById('inpW').value, h = document.getElementById('inpH').value;
    const temp = canvas.toDataURL();
    canvas.width = w; canvas.height = h;
    const img = new Image();
    img.onload = () => { ctx.fillStyle = "#fff"; ctx.fillRect(0,0,w,h); ctx.drawImage(img, 0, 0); saveHistory(); };
    img.src = temp;
    resetView();
}

function handleImage(e) {
    const reader = new FileReader();
    reader.onload = (ev) => {
        const img = new Image();
        img.onload = () => { ctx.drawImage(img, 0, 0, canvas.width, canvas.height); saveHistory(); };
        img.src = ev.target.result;
    };
    reader.readAsDataURL(e.target.files[0]);
}

function resetView() {
    scale = Math.min(viewport.clientWidth / canvas.width, viewport.clientHeight / canvas.height) * 0.9;
    pX = (viewport.clientWidth - canvas.width * scale) / 2; pY = 20;
    updateTransform();
}

function updateTransform() { canvas.style.transform = `translate(${pX}px, ${pY}px) scale(${scale})`; }

function getPos(e) {
    const rect = viewport.getBoundingClientRect();
    const t = e.touches ? e.touches[0] : e;
    return { x: (t.clientX - rect.left - pX) / scale, y: (t.clientY - rect.top - pY) / scale };
}

let sD = 0, sS = 1, sX = 0, sY = 0;
viewport.addEventListener('touchstart', e => {
    if(e.touches.length === 2) {
        isDrawing = false;
        sD = Math.hypot(e.touches[0].clientX - e.touches[1].clientX, e.touches[0].clientY - e.touches[1].clientY);
        sS = scale; sX = (e.touches[0].clientX + e.touches[1].clientX) / 2 - pX; sY = (e.touches[0].clientY + e.touches[1].clientY) / 2 - pY;
    } else {
        isDrawing = true;
        const p = getPos(e); lastX = p.x; lastY = p.y;
        if(mode === 'fill') { ctx.fillStyle = preview.style.background; ctx.fillRect(0,0,canvas.width,canvas.height); saveHistory(); }
    }
}, {passive: false});

viewport.addEventListener('touchmove', e => {
    e.preventDefault();
    if(e.touches.length === 2) {
        const d = Math.hypot(e.touches[0].clientX - e.touches[1].clientX, e.touches[0].clientY - e.touches[1].clientY);
        scale = sS * (d / sD);
        pX = (e.touches[0].clientX + e.touches[1].clientX) / 2 - sX;
        pY = (e.touches[0].clientY + e.touches[1].clientY) / 2 - sY;
        updateTransform();
    } else if(isDrawing) {
        const p = getPos(e);
        ctx.beginPath(); ctx.moveTo(lastX, lastY); ctx.lineTo(p.x, p.y);
        ctx.lineCap = "round"; ctx.lineWidth = document.getElementById('size').value;
        ctx.strokeStyle = (mode === 'erase') ? '#ffffff' : preview.style.background;
        ctx.stroke(); lastX = p.x; lastY = p.y;
    }
}, {passive: false});

window.addEventListener('touchend', () => { if(isDrawing) saveHistory(); isDrawing = false; });

ctx.fillStyle = "#fff"; ctx.fillRect(0,0,360,500);
saveHistory();
initLangMenu();
applyLang();
updColor();
setTimeout(resetView, 200);

window.downloadImg = () => {
    const link = document.createElement('a');
    link.download = 'art.jpg';
    link.href = canvas.toDataURL('image/jpeg');
    link.click();
};
</script>
</body>
                                  </html>
  
